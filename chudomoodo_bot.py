"""
chudomoodo_bot.py

Telegram-–±–æ—Ç "–î–Ω–µ–≤–Ω–∏–∫ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π".

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã-—Ä–∞–¥–æ—Å—Ç–∏;
- –æ—á–∏—â–∞–µ—Ç –º–∞—Ç –∏ –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—É—é –ª–µ–∫—Å–∏–∫—É (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –∫–æ—Ä–Ω–µ–π);
- —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–∞–¥–æ—Å—Ç–∏ –≤ SQLite;
- –ï–ñ–ï–î–ù–ï–í–ù–´–ô –†–ï–ñ–ò–ú:
    - –≤ 18:00 ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞ –¥–µ–Ω—å –Ω–µ –±—ã–ª–æ –Ω–∏ –æ–¥–Ω–æ–π —Ä–∞–¥–æ—Å—Ç–∏;
    - –≤ 21:00 ‚Äî –æ—Ç—á—ë—Ç —Å —Ä–∞–¥–æ—Å—Ç—è–º–∏ –∑–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è;
- –∑–∞—â–∏—Ç–∞ –æ—Ç —Ç–æ—Å–∫–∏: –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –≥—Ä—É—Å—Ç—å, —É—Å—Ç–∞–ª–æ—Å—Ç—å, —Ç—Ä–µ–≤–æ–≥—É, —Ç—è–∂—ë–ª—ã–µ —Ñ—Ä–∞–∑—ã;
- —Å–ø–æ–∫–æ–π–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã-–æ—Ç–≤–µ—Ç—ã —Å –æ–¥–Ω–∏–º —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ;
- –∞—á–∏–≤–∫–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–¥–æ—Å—Ç–µ–π –∏ —Å—Ç—Ä–∏–∫–∏ –ø–æ –¥–Ω—è–º;
- —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ /stats;
- –ø–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /letter —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω—ã /cancel;
- —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ –≥—Ä—É—Å—Ç–∏, —É—Å—Ç–∞–ª–æ—Å—Ç–∏, —Ç—Ä–µ–≤–æ–≥–∏ –∏ ¬´–Ω–µ –∑–Ω–∞—é, —á—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å¬ª;
- –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π;
- –æ—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –º–∞—Ç, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–∞–∑—ã –∏ ¬´–Ω–µ –∑–Ω–∞—é, —á—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å¬ª;
- –Ω–∞ –æ–¥–Ω—É —ç–º–æ—Ü–∏—é ‚Äî –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç (–±–µ–∑ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π).
"""

import os
import time
import sqlite3
import threading
import random
import re
import json
from datetime import datetime, timedelta, date
from typing import List, Tuple, Optional, Dict

import requests

# --------------------------
# CONFIG
# --------------------------

TOKEN = os.getenv("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω TELEGRAM_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

API_URL = f"https://api.telegram.org/bot{TOKEN}"
DB_PATH = os.path.join(os.path.dirname(__file__), "joys.db")

POLL_TIMEOUT = 30
POLL_SLEEP = 1

# –°–ª–æ–≤–∞—Ä–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
# ... (–≤—Å–µ —Å–ª–æ–≤–∞—Ä–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
GREETING_RESPONSES = [
    "–ü—Ä–∏–≤–µ—Ç!–ë–æ–ª—å—à–æ–µ —Å—á–∞—Å—Ç—å–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –º–∞–ª–µ–Ω—å–∫–∏—Ö –º–≥–Ω–æ–≤–µ–Ω–∏–π. –ö–∞–∫–æ–µ –∏–∑ –Ω–∏—Ö –∑–∞–ø–æ–º–Ω–∏–ª–æ—Å—å —Ç–µ–±–µ —Å–µ–≥–æ–¥–Ω—è?",
    "–°–∞–ª—é—Ç!–Ø –∑–¥–µ—Å—å. –°–∫–∏–Ω—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–¥–∏–Ω —Ö–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–º–µ—à–Ω–æ–π –º–µ–º, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —É–≤–∏–¥–µ–ª.",
    "–†–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å –∑–¥–µ—Å—å. –î–∞–≤–∞–π –æ—Ç–º–µ—Ç–∏–º —á—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–∏—è—Ç–Ω–æ–µ –∏–∑ —ç—Ç–æ–≥–æ –¥–Ω—è?",
    "–ü—Ä–∏–≤–µ—Ç. –ì–æ—Ç–æ–≤ –∫ –Ω–µ–±–æ–ª—å—à–æ–º—É –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é? –ü—Ä–µ–¥–ª–∞–≥–∞—é –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ —Å–∞–º—ã–π –æ–±—ã—á–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ç–≤–æ–µ–≥–æ –¥–Ω—è –∏ –Ω–∞–π—Ç–∏ –≤ –Ω—ë–º —á—Ç–æ-—Ç–æ —Ç—ë–ø–ª–æ–µ.",
    "–ü—Ä–∏–≤–µ—Ç! –Ø –≤ —Å—Ç—Ä–æ—é. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –æ–¥–Ω—É –ø—Ä–∏—á–∏–Ω—É –¥–ª—è —É–ª—ã–±–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è? –î–æ–ø—É—Å—Ç–∏–º, –∫–∞–∫ –ø—Ç–∏—Ü—ã –ø–µ–ª–∏ –∑–∞ –æ–∫–Ω–æ–º.",
    "–ü—Ä–∏–≤–µ—Ç. –ú–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å —Å–∞–º–æ–π –ø—Ä–æ—Å—Ç–æ–π —Ä–∞–¥–æ—Å—Ç–∏ ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Ç—ã –≤–æ–æ–±—â–µ –¥–æ–±—Ä–∞–ª–∞—Å—å –¥–æ —ç—Ç–æ–≥–æ —á–∞—Ç–∞.",
    "–¢–∞–∫, —è —Ç—É—Ç. –û—Ç–º–µ—á–∞–µ–º –æ–¥–Ω—É –º–∏–∫—Ä–æ-–ø–æ–±–µ–¥—É? –¢–∏–ø–∞ ¬´–≤—Å—Ç–∞–ª —Å –∫—Ä–æ–≤–∞—Ç–∏ —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏¬ª –∏–ª–∏ ¬´–∫–æ–ª–ª–µ–≥–∞ –ø—Ä–∏–Ω–µ—Å –ø–µ—á–µ–Ω—å–∫—É¬ª.",
    "–ü—Ä–∏–≤–µ—Ç! –Ø –Ω–∞ –ø–æ—Å—Ç—É. –ü—Ä–∏—à–ª–∏ –≤ —á–∞—Ç –æ–¥–Ω—É –ø—Ä–∏—è—Ç–Ω—É—é –º–µ–ª–æ—á—å ‚Äî —Å–∫–∞–∂–µ–º, –∫–∞–∫ —É—Ç—Ä–æ–º –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è —Å–∏–º–ø–∞—Ç–∏—á–Ω—ã–π —Å–æ—Å–µ–¥",
    "–≠–π, —è —Ç—É—Ç. –ù–∞–∑–æ–≤–∏ –æ–¥–Ω—É –≤–µ—â—å, –∫–æ—Ç–æ—Ä–∞—è —Å–µ–≥–æ–¥–Ω—è –Ω–µ —Ä–∞–∑–æ–∑–ª–∏–ª–∞ ‚Äî –∏ –º—ã –Ω–∞—á–Ω–µ–º –Ω–∞—à—É —Ç–∞–π–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –ø–æ –ø–æ–∏—Å–∫—É —Ö–æ—Ä–æ—à–µ–≥–æ.",
    "–ü—Ä–∏–≤–µ—Ç! –°–∫–∏–Ω—å —á—Ç–æ-—Ç–æ, —á—Ç–æ –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏–ª–æ —Ç–µ–±–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ ‚Äî –∞ —è –∏–∑ —ç—Ç–æ–≥–æ —Å–¥–µ–ª–∞–µ–º –Ω–∞—à —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø–æ–≤–æ–¥ –¥–ª—è —É–ª—ã–±–∫–∏.",
    "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç—É—Ç –∫–∞–∫ —Ç–∞–π–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ç–≤–æ–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π-–Ω–µ–≤–∏–¥–∏–º–æ–∫. –°–±—Ä–∞—Å—ã–≤–∞–π ‚Äî —Å–ø—Ä—è—á—É –ø–æ–¥ —Ü–∏—Ñ—Ä–æ–≤—É—é –ø–æ–¥—É—à–∫—É.",
    "–ë—É! –†–∞–¥–∞ —Ç–µ–±—è —Å–ª—ã—à–∞—Ç—å! –£ —Ç–µ–±—è –±—ã–ª–æ —á—Ç–æ-—Ç–æ —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ –≤—ã–∑–≤–∞–ª–æ –º—ã—Å–ª–µ–Ω–Ω–æ–µ ¬´–º–º, –Ω–µ–ø–ª–æ—Ö–æ¬ª?",
    "–ü—Ä–∏–≤–µ—Ç! –ü—Ä–µ–¥–ª–∞–≥–∞—é —Å—Ç–∞—Ä—Ç–∞–Ω—É—Ç—å —Å —á–µ–≥–æ-—Ç–æ –æ—á–µ–≤–∏–¥–Ω–æ–≥–æ: —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ç–≤–æ–∏–º –±–∞–∑–æ–≤—ã–º –º–∏–Ω–∏–º—É–º–æ–º? –ï–¥–∞, –º—É–∑—ã–∫–∞ –∏–ª–∏ –∫–æ—Ñ–µ?",
    "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫–æ–π  –º–æ–º–µ–Ω—Ç –∏–∑ —Å–µ–≥–æ–¥–Ω—è—à–µ–≥–æ –¥–Ω—è —Å—Ç–æ–∏—Ç –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π –≤ –∑–∞–≤—Ç—Ä–∞?",
    "–†–∞–¥, —á—Ç–æ —Ç—ã –∑–∞–≥–ª—è–Ω—É–ª–∞! –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ‚Äî –Ω–∞–ø–∏—à–∏,—á—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Ç–µ–±—è –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ) –ú–æ–∂–Ω–æ –±–µ–∑ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π.",
]

JOY_EMOJIS = ["‚ú®", "üòä", "üåà", "üíõ", "üåü"]
REMINDER_EMOJIS = ["‚ú®", "üìå", "üòä"]
STATS_EMOJIS = ["üìä", "üìà", "‚≠ê"]
CALM_EMOJIS = ["üôÇ", "üåø", "‚ú®", "‚òï", "üïä", "üçÉ"]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ –≥—Ä—É—Å—Ç—å
SAD_RESPONSES = [
    "–ó–≤—É—á–∏—Ç –∫–∞–∫ –æ—á–µ–Ω—å –Ω–µ–ø—Ä–æ—Å—Ç–æ–π –¥–µ–Ω—å. –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –∏—Å–∫–∞—Ç—å –≤ –Ω—ë–º –ø–ª—é—Å—ã\n–ï—Å–ª–∏ –ø–æ–∑–∂–µ –≤—Å–ø–æ–º–Ω–∏—Ç—Å—è –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –Ω–∞ –¥—É—à–µ —Å—Ç–∞–ª–æ —Å–≤–µ—Ç–ª–µ–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –∫–∏–Ω—å –µ–≥–æ —Å—é–¥–∞, —è –ø–æ–ª–æ–∂—É –≤ –Ω–∞—à—É –∫–æ–ø–∏–ª–∫—É.",
    "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –º–æ–≥–ª–æ –±—ã—Ç—å —Ç—è–∂–∫–æ\n–ï—Å–ª–∏ –≤–µ—á–µ—Ä–æ–º –≤–¥—Ä—É–≥ –≤—Å–ø–æ–º–Ω–∏—Ç—Å—è —á—Ç–æ-—Ç–æ, —á—Ç–æ –≤—ã–∑–≤–∞–ª–æ –ª—ë–≥–∫—É—é —É–ª—ã–±–∫—É ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–æ –¥–ª—è –º–µ–Ω—è, —è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–ª–æ–∂—É –∫ –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ä–∞–¥–æ—Å—Ç—è–º.",
    "–ú–æ–∂–µ—à—å –ø—Ä–æ—Å—Ç–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º –æ–ø–∏—Å–∞—Ç—å –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Å–µ–≥–æ–¥–Ω—è —Å—Ç–∞–ª–æ —á—É—Ç—å —Å–ø–æ–∫–æ–π–Ω–µ–µ –Ω–∞ –¥—É—à–µ ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –¥–ª–∏–ª—Å—è —Å–µ–∫—É–Ω–¥—É. –Ø –∑–∞–ø–æ–º–Ω—é.",
    "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ç—è–∂–µ–ª–æ–≤–∞—Ç–æ. –ù–µ –∑–∞—Å—Ç–∞–≤–ª—è–π —Å–µ–±—è –∏—Å–∫–∞—Ç—å –ø–ª—é—Å—ã. –ï—Å–ª–∏ –≤–µ—á–µ—Ä–æ–º –≤—Å–ø–æ–º–Ω–∏—Ç—Å—è —á—Ç–æ-—Ç–æ, —á—Ç–æ —Ö–æ—Ç—å –Ω–∞ –º–∏–Ω—É—Ç—É –æ—Ç–ø—É—Å—Ç–∏–ª–æ ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–≥–æ—Ä—è—á–∏–π –¥—É—à¬ª –∏–ª–∏ ¬´—Ç–∏—à–∏–Ω–∞¬ª ‚Äî –ø—Ä–∏—à–ª–∏, —è –∑–∞–ø–∏—à—É.",
    "–í–∏–∂—É, —á—Ç–æ –¥–µ–Ω—å –±—ã–ª –Ω–µ —Å–∞—Ö–∞—Ä. –ú–æ–∂–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–π–º–∞–µ—à—å —Å–µ–±—è –Ω–∞ —á—ë–º-—Ç–æ –≤—Ä–æ–¥–µ ¬´–∫–æ—Ñ–µ –ø–æ–º–æ–≥¬ª –∏–ª–∏ ¬´–±–µ—Å—Ç–∏—Å –ø—Ä–∏—Å–ª–∞–ª–∞ —Å–º–µ—à–Ω–æ–π –º–µ–º¬ª ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ, —è –∑–∞–ø–æ–º–Ω—é.",
    "–ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –±—ã–ª–æ –Ω–µ–ª–µ–≥–∫–æ. –ù–µ —Å—Ç–æ–∏—Ç —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å —Ö–æ—Ä–æ—à–µ–µ. –ï—Å–ª–∏ –Ω–µ–≤–∑–Ω–∞—á–∞–π –≤—Å–ø–æ–º–Ω–∏—Ç—Å—è –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Å—Ç–∞–ª–æ —á—É—Ç—å –ª–µ–≥—á–µ ‚Äî –Ω–∞–ø–∏—à–∏ –≤ 2 —Å–ª–æ–≤–∞—Ö, —è —Å–æ—Ö—Ä–∞–Ω—é –∫–∞–∫ –µ—Å—Ç—å.",
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —É—Å—Ç–∞–ª–æ—Å—Ç—å
TIRED_RESPONSES = [
    "–û–π, –≤—Å—ë –≤–∏–∂—É. –ú–æ–ª—á–∏, –º–æ–ª—á–∏. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–∑–∂–µ –≤—Å–ø–æ–º–Ω–∏—Ç—Å—è —á—Ç–æ-—Ç–æ –ø—Ä–æ—Å—Ç–æ–µ –≤—Ä–æ–¥–µ ¬´–¥–æ–∂–¥—å –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∫–∞–∫ –ø–æ –∑–∞–∫–∞–∑—É¬ª ‚Äî —è –Ω–∞ –ø–æ–¥—Ö–≤–∞—Ç–µ. –°–æ—Ö—Ä–∞–Ω—é –≤ —Å–ø–µ—Ü–æ—Ç–¥–µ–ª–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π.",
    "–¢–∞–∫, —Å —Ç–æ–±–æ–π –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ. –ú–æ–∂–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç—å. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–π–º–∞–µ—à—å —Å–µ–±—è –Ω–∞ –º—ã—Å–ª–∏ ¬´–£ –º–µ–Ω—è –∂–µ –æ—Å—Ç–∞–ª–∏—Å—å –∫–æ–Ω—Ñ–µ—Ç—ã!¬ª ‚Äî —ç—Ç–æ —É–∂–µ –ø–æ–≤–æ–¥ –¥–ª—è –Ω–∞—à–µ–≥–æ —á–∞—Ç–∞!",
    "–ù—É —á—Ç–æ, –≥–µ—Ä–æ–π? –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —Å–æ—Å–µ–¥ –Ω–∞–∫–æ–Ω–µ—Ü –ø–µ—Ä–µ—Å—Ç–∞–ª —Å–≤–µ—Ä–ª–∏—Ç—å —Å—Ç–µ–Ω—É ‚Äî —ç—Ç–æ —É–∂–µ –ø–æ–±–µ–¥–∞. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º!",
    "–ú–¥–∞-–∞-–∞, –∫–∞—Ä—Ç–∏–Ω–∞ —è—Å–Ω–∞. –ú–æ–ª—á—É –∫–∞–∫ —Ä—ã–±–∞. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –≤—Å–ø–æ–º–Ω–∏—à—å, –∫–∞–∫ —Ç–≤–æ–π –∫–æ—Ç–∏–∫ —Å–ø–∞–ª —Ä—è–¥–æ–º –≤—Ä–æ–¥–µ ‚Äî —è –Ω–∞ –Ω–∏–∑–∫–æ–º —Å—Ç–∞—Ä—Ç–µ! –û—Ç–ø—Ä–∞–≤–ª—é –≤ –Ω–∞—à—É –∫–æ–ª–ª–µ–∫—Ü–∏—é —Ä–∞–¥–æ—Å—Ç–µ–π",
    "–¢—ã –Ω–µ —Å–¥–∞—ë—à—å—Å—è ‚Äî —Ç—ã –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–ª —Ç–∞—â–∏—Ç—å —Ü–µ–ª—ã–π –º–∏—Ä. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ–π–º–∞–µ—à—å –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Å—Ç–∞–ª–æ —Ö–æ—Ç—å —á—É—Ç—å-—á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ ‚Äî —ç—Ç–æ —É–∂–µ –ø—Ä–æ—Ä—ã–≤! –°–æ–æ–±—â–∏ ‚Äî –∑–∞–ø–∏—à–µ–º –≤ –Ω–∞—à –∞—Ä—Ö–∏–≤ –ø–æ–±–µ–¥.",
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ç—Ä–µ–≤–æ–≥—É
ANXIETY_RESPONSES = [
    "–≠—Ö, —Å–ª—ã—à—É, –∫–∞–∫ —Ç—Ä–µ–≤–æ–∂–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –∑–∞–≤–µ–ª–∞—Å—å... –ó–Ω–∞–µ—à—å, —ç—Ç–æ –∂–µ –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Ç–µ–±–µ –Ω–µ –≤—Å—ë —Ä–∞–≤–Ω–æ. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ‚Äî –º–æ–∂–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å —ç—Ç—É –∫–∞—à—É –≤ –≥–æ–ª–æ–≤–µ –ø–æ –ø–æ–ª–æ—á–∫–∞–º. –Ø —Å –ª—É–ø—è –∏ —Ç–µ—Ä–ø–µ–Ω–∏–µ–º!",
    "–û–π, –∑–Ω–∞–∫–æ–º–æ–µ —á—É–≤—Å—Ç–≤–æ ‚Äî –±—É–¥—Ç–æ –≤–Ω—É—Ç—Ä–∏ –º–æ—Ç–æ—Ä—á–∏–∫ –∑–∞–≤–µ–ª—Å—è. –≠—Ç–æ –∂ –ø—Ä–æ—Å—Ç–æ —Ç–≤–æ—ë —Å–µ—Ä–¥—Ü–µ –≥—Ä–æ–º–∫–æ —Å—Ç—É—á–∏—Ç –ø–æ –≤–∞–∂–Ω—ã–º –¥–ª—è —Ç–µ–±—è –≤–µ—â–∞–º!",
    "–¢–∞–∫-—Ç–∞–∫, —Ç—Ä–µ–≤–æ–≥–∞ –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ! –ù–æ –µ—Å–ª–∏ –ø—Ä–∏—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–±–æ—Ç–∞ –æ —Ç–æ–º, —á—Ç–æ —Ç–µ–±–µ –¥–æ—Ä–æ–≥–æ.",
    "–°–ª—É—à–∞–π, –∞ –≤–µ–¥—å —Ç–≤–æ—è —Ç—Ä–µ–≤–æ–∂–∫–∞ ‚Äî —ç—Ç–æ –∫–∞–∫ —Å—É–ø–µ—Ä—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å '–≥–∏–ø–µ—Ä-–∑–∞–±–æ—Ç–∞ –æ –≤–∞–∂–Ω–æ–º'. –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞ –ø—Ä–æ–∫–∞—á–∞–Ω–∞ –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞.",
    "–≠—Ö, —Å–º–æ—Ç—Ä—é ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫—Ä–∏—Ç–∏–∫ –æ–ø—è—Ç—å —É—Å—Ç—Ä–æ–∏–ª –¥—Ä–∞–º—É –∫–∞–∫ –≤ —Å–µ—Ä–∏–∞–ª–µ. –ê –≤–µ–¥—å —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–≤–æ—è —Å—É–ø–µ—Ä—Å–∏–ª–∞ ‚Äî –∑–∞–º–µ—á–∞—Ç—å –∫–∞–∂–¥—É—é –º–µ–ª–æ—á—å!",
]

# –û—Ç–≤–µ—Ç—ã, –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç ¬´–Ω–µ –∑–Ω–∞—é, —á—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å¬ª
NO_JOY_RESPONSES = [
    "–ù–∏—á–µ–≥–æ, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –ø—É—Å—Ç–æ. –ë—ã–≤–∞–µ—Ç. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π. –ï—Å–ª–∏ –≤–µ—á–µ—Ä–æ–º –≤–¥—Ä—É–≥ –≤—Å–ø–ª—ã–≤—ë—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ ¬´–∏–≥—Ä–∞–ª–∞ –º–æ—è –ª—é–±–∏–º–∞—è –ø–µ—Å–Ω—è¬ª –∏–ª–∏ ¬´–∫–ª–∞—Å—Å–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –Ω–∞ WB¬ª ‚Äî –Ω–∞–ø–∏—à–∏ –º–Ω–µ. –Ø —Å–æ—Ö—Ä–∞–Ω—é.",
    "–ü—É—Å—Ç–æ—Ç–∞ –≤ –¥–Ω—è—Ö ‚Äî —ç—Ç–æ –∫–∞–∫ –ø–∞—É–∑–∞ –≤ –º—É–∑—ã–∫–µ. –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –µ—ë –∑–∞–ø–æ–ª–Ω—è—Ç—å.",
    "–ù–∏–∫–∞–∫–∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π! –ù–æ –µ—Å–ª–∏ –≤–¥—Ä—É–≥... –í—Å–ø–æ–º–Ω–∏—à—å –≥–æ–ª—É–±—è —Å —Å–º–µ—à–Ω–æ–π –ø–æ—Ö–æ–¥–∫–æ–π –∏–ª–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç ‚Äî —ç—Ç–æ –ø–æ–≤–æ–¥ –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ!",
    "–ù–∏—á–µ–≥–æ, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –∫–∞–∫ —á–∏—Å—Ç—ã–π –ª–∏—Å—Ç. –ë—ã–≤–∞–µ—Ç. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –≤–µ—á–µ—Ä–æ–º –≤—Å–ø–æ–º–Ω–∏—Ç—Å—è —á—Ç–æ-—Ç–æ - —è –Ω–∞ –Ω–∏–∑–∫–æ–º —Å—Ç–∞—Ä—Ç–µ",
    "–†–∞–∑—Ä–µ—à–∞—é —Å–µ–≥–æ–¥–Ω—è –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å.",
    "–ü—É—Å—Ç–æ–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ –∂–µ –∫–∞–∫ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞!",
    "–ü—É—Å—Ç–æ—Ç–∞ ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –æ–ø—ã—Ç. –ù–∏–∫–∞–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è!",
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ä–∞–¥–æ—Å—Ç–∏
JOY_RESPONSES = [
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ —ç—Ç–æ –≤ –∫–æ–ø–∏–ª–∫—É —Ö–æ—Ä–æ—à–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤",
    "–û—Å—Ç–∞–≤–∏–ª–∞ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –∑–¥–µ—Å—å ‚Äî —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø–æ—Ç–µ—Ä—è–ª—Å—è –≤ —Å—É–µ—Ç–µ",
    "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∞! –ó–∞–Ω–µ—Å–µ–Ω–æ –≤ —Ä–µ–µ—Å—Ç—Ä —É–ª—ã–±–æ–∫!",
    "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª ¬´–≤–Ω–µ–∑–∞–ø–Ω—ã–µ —Ä–∞–¥–æ—Å—Ç–∏¬ª! –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω –æ—Ç –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –ø–µ—Ä–≤–æ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é.",
    "–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –æ—Ç–¥–µ–ª —Ü–µ–Ω–Ω—ã—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π!",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É ¬´–¢–æ, —á—Ç–æ –≥—Ä–µ–µ—Ç –¥—É—à—É¬ª.",
    "–ó–∞–ª–æ–∂–∏–ª–∞ –≤ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –Ω–∞—à–µ–≥–æ –æ–±—â–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!",
    "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–ø–∏–ª–∫—É! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –±—É–¥–µ—Ç —Ç–µ–º —è–∫–æ—Ä–µ–º, —á—Ç–æ –¥–µ—Ä–∂–∏—Ç –Ω–∞ –ø–ª–∞–≤—É –≤ –±—É—Ä–Ω—ã–π –¥–µ–Ω—å",
    "–û—Ç–ø—Ä–∞–≤–∏–ª–∞ –≤ –Ω–∞—à—É '–ø–∞–ø–∫—É —Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö –º–µ–ª–æ—á–µ–π'! –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ‚Äî –∑–∞—â–∏—â–µ–Ω –æ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Ö–∞–æ—Å–∞ –∏ –ø–ª–æ—Ö–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ '—ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é'. –¢–µ–ø–µ—Ä—å —ç—Ç–æ —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∑–∞–ø–∞—Å –ø–æ–∑–∏—Ç–∏–≤–∞!",
    "–ü–µ—Ä–µ–¥–∞–ª–∞ –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É —Ä–µ–±–µ–Ω–∫—É! –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –±—É–¥–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ —Å–µ–±–µ –≤ —Å–∞–º—ã–µ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.",
    "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∞ –≤ –∂—É—Ä–Ω–∞–ª–µ '–ü–æ–≤–æ–¥–æ–≤ –¥–ª—è —É–ª—ã–±–∫–∏'!",
    "–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –æ—Ç–¥–µ–ª '–¶–µ–Ω–Ω—ã—Ö –º–≥–Ω–æ–≤–µ–Ω–∏–π'! –≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–ø–∞—Å–∞ —Ö–æ—Ä–æ—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é '–°–ª—É—á–∞–π–Ω–æ–≥–æ —Å—á–∞—Å—Ç—å—è'! –¢–µ–ø–µ—Ä—å –æ–Ω –±—É–¥–µ—Ç –≤—Å–ø–ª—ã–≤–∞—Ç—å –≤ —Å–∞–º—ã–µ –Ω—É–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.",
]

LAST_JOY_INDEX: dict[int, int] = {}

# --------------------------
# Telegram API
# --------------------------

def get_updates(offset: Optional[int] = None, timeout: int = POLL_TIMEOUT) -> List[dict]:
    params = {"timeout": timeout}
    if offset is not None:
        params["offset"] = offset
    try:
        resp = requests.get(f"{API_URL}/getUpdates", params=params, timeout=timeout + 5)
        data = resp.json()
        if not data.get("ok"):
            print("getUpdates error:", data)
            return []
        return data.get("result", [])
    except Exception as e:
        print("getUpdates exception:", e)
        return []


def send_message(chat_id: int, text: str):
    try:
        requests.post(
            f"{API_URL}/sendMessage",
            json={"chat_id": chat_id, "text": text},
            timeout=10,
        )
    except Exception as e:
        print("sendMessage error:", e)


# --------------------------
# DB
# --------------------------

def init_db():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    # —Ä–∞–¥–æ—Å—Ç–∏
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS joys (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            text TEXT NOT NULL,
            created_at TEXT NOT NULL
        )
        """
    )
    # —Ç—è–∂—ë–ª—ã–µ/–≥—Ä—É—Å—Ç–Ω—ã–µ/—Ç—Ä–µ–≤–æ–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS sad_events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            created_at TEXT NOT NULL
        )
        """
    )
    # —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS dialog_state (
            chat_id INTEGER PRIMARY KEY,
            state TEXT NOT NULL,
            meta TEXT,
            updated_at TEXT NOT NULL
        )
        """
    )
    # –ø–∏—Å—å–º–∞ –≤ –±—É–¥—É—â–µ–µ
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS future_letters (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            text TEXT NOT NULL,
            send_at TEXT NOT NULL,
            created_at TEXT NOT NULL,
            sent INTEGER NOT NULL DEFAULT 0
        )
        """
    )
    # –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS sent_reminders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            reminder_date TEXT NOT NULL,
            reminder_type TEXT NOT NULL, -- 'reminder' –∏–ª–∏ 'report'
            sent_at TEXT NOT NULL,
            UNIQUE(chat_id, reminder_date, reminder_type)
        )
        """
    )
    conn.commit()
    conn.close()


def add_joy(chat_id: int, text: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    created_at = datetime.now().isoformat(timespec="seconds")
    cur.execute(
        "INSERT INTO joys (chat_id, text, created_at) VALUES (?, ?, ?)",
        (chat_id, text, created_at),
    )
    conn.commit()
    conn.close()


def add_sad_event(chat_id: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    created_at = datetime.now().isoformat(timespec="seconds")
    cur.execute(
        "INSERT INTO sad_events (chat_id, created_at) VALUES (?, ?)",
        (chat_id, created_at),
    )
    conn.commit()
    conn.close()


def get_joy_count(chat_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT COUNT(*) FROM joys WHERE chat_id = ?",
        (chat_id,),
    )
    count = cur.fetchone()[0]
    conn.close()
    return count


def has_joy_for_date(chat_id: int, date_obj: date) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    date_str = date_obj.isoformat()
    cur.execute(
        """
        SELECT COUNT(*)
        FROM joys
        WHERE chat_id = ?
          AND substr(created_at, 1, 10) = ?
        """,
        (chat_id, date_str),
    )
    count = cur.fetchone()[0]
    conn.close()
    return count > 0


def get_all_user_ids() -> List[int]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT DISTINCT chat_id FROM joys")
    rows = cur.fetchall()
    conn.close()
    return [r[0] for r in rows]


def set_dialog_state(chat_id: int, state: str, meta: Optional[dict] = None):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    now = datetime.now().isoformat(timespec="seconds")
    meta_json = json.dumps(meta) if meta is not None else None
    cur.execute(
        """
        INSERT INTO dialog_state (chat_id, state, meta, updated_at)
        VALUES (?, ?, ?, ?)
        ON CONFLICT(chat_id) DO UPDATE SET
            state = excluded.state,
            meta = excluded.meta,
            updated_at = excluded.updated_at
        """,
        (chat_id, state, meta_json, now),
    )
    conn.commit()
    conn.close()


def get_dialog_state(chat_id: int) -> Tuple[Optional[str], Optional[dict]]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT state, meta FROM dialog_state WHERE chat_id = ?",
        (chat_id,),
    )
    row = cur.fetchone()
    conn.close()
    if not row:
        return None, None
    state, meta_json = row
    meta = None
    if meta_json:
        try:
            meta = json.loads(meta_json)
        except Exception:
            meta = None
    return state, meta


def clear_dialog_state(chat_id: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("DELETE FROM dialog_state WHERE chat_id = ?", (chat_id,))
    conn.commit()
    conn.close()


def has_sent_reminder_today(chat_id: int, reminder_type: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª–æ –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è"""
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    today = date.today().isoformat()
    cur.execute(
        """
        SELECT COUNT(*)
        FROM sent_reminders
        WHERE chat_id = ? 
          AND reminder_date = ?
          AND reminder_type = ?
        """,
        (chat_id, today, reminder_type),
    )
    count = cur.fetchone()[0]
    conn.close()
    return count > 0


def mark_reminder_sent(chat_id: int, reminder_type: str):
    """–û—Ç–º–µ—á–∞–µ—Ç, —á—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è"""
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    today = date.today().isoformat()
    sent_at = datetime.now().isoformat(timespec="seconds")
    
    try:
        cur.execute(
            """
            INSERT INTO sent_reminders (chat_id, reminder_date, reminder_type, sent_at)
            VALUES (?, ?, ?, ?)
            """,
            (chat_id, today, reminder_type, sent_at),
        )
        conn.commit()
    except sqlite3.IntegrityError:
        # –£–∂–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è - –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ
        pass
    finally:
        conn.close()


# --------------------------
# –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç–∞
# --------------------------

def normalize_text_for_match(text: str) -> str:
    lower = text.lower().replace("—ë", "–µ")
    normalized = re.sub(r"[^\w\s]+", " ", lower)
    normalized = " ".join(normalized.split())
    return normalized


def contains_profanity(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –º–∞—Ç"""
    normalized = normalize_text_for_match(text)
    for bad_word in BAD_WORDS:
        if bad_word in normalized:
            return True
    return False


def clean_profanity(text: str) -> str:
    """–û—á–∏—â–∞–µ—Ç –º–∞—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    words = text.split()
    cleaned_words = []
    
    for word in words:
        lower_word = word.lower()
        word_cleaned = False
        
        for bad_root in BAD_WORDS:
            if bad_root in lower_word:
                cleaned_word = ""
                for char in word:
                    if char.isalpha():
                        cleaned_word += "*"
                    else:
                        cleaned_word += char
                cleaned_words.append(cleaned_word)
                word_cleaned = True
                break
        
        if not word_cleaned:
            cleaned_words.append(word)
    
    return " ".join(cleaned_words)


def clean_text_pipeline(text: str) -> str:
    text = text.strip()
    if not text:
        return text
    text = clean_profanity(text)
    return text


# --------------------------
# –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
# --------------------------

def is_severe_sad_message(text: str) -> bool:
    lower = normalize_text_for_match(text)
    return any(p in lower for p in SEVERE_SAD_PATTERNS)


def is_sad_message(text: str) -> bool:
    lower = normalize_text_for_match(text)
    return any(p in lower for p in SAD_PATTERNS)


def is_tired_message(text: str) -> bool:
    lower = normalize_text_for_match(text)
    return any(p in lower for p in TIRED_PATTERNS)


def is_anxiety_message(text: str) -> bool:
    lower = normalize_text_for_match(text)
    return any(p in lower for p in ANXIETY_PATTERNS)


def is_no_joy_message(text: str) -> bool:
    lower = normalize_text_for_match(text)
    return any(p in lower for p in NO_JOY_PATTERNS)


def is_cancel_message(text: str) -> bool:
    lower = normalize_text_for_match(text)
    return any(p in lower for p in CANCEL_PATTERNS)


def is_greeting_message(text: str) -> bool:
    """–ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è"""
    lower = normalize_text_for_match(text)
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ - —Ç–æ—á–Ω–æ –Ω–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if len(lower) > 25:
        return False
    
    # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏
    exact_greetings = {
        "–ø—Ä–∏–≤–µ—Ç", "–ø—Ä–∏–≤–µ—Ç!", "–ø—Ä–∏–≤–µ—Ç–∏–∫", "–ø—Ä–∏–≤–µ—Ç–∏–∫–∏", "–ø—Ä–∏–≤–µ—Ç)", "–ø—Ä–∏–≤–µ—Ç))", 
        "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ)", 
        "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ", "–¥–æ–±—Ä–æ–π –Ω–æ—á–∏",
        "—Ö–∞–π", "—Ö–∞–π!", "—Ö–∞–π)", "—Ö—ç–π", "—Ö–µ–π", "—Ö–µ–ª–ª–æ", "—Ö–µ–ª–ª–æ—É", 
        "hello", "hi", "hey", "–π–æ—É", "–π–æ", "–π–æ—É)", "–π–æ—É!", "–∫—É", "–∫—É!", "–∫—É)",
        "–∑–¥–æ—Ä–æ–≤–æ", "–∑–¥–æ—Ä–æ–≤", "–∑–¥–∞—Ä–æ–≤–∞", "–∑–¥–∞—Ä–æ–≤", "–∑–¥–æ—Ä–æ–≤–∞", "—Å–∞–ª—é—Ç",
        "—à–∞–ª–æ–º", "–±–æ–Ω–∂—É—Ä", "—Ö–æ–ª–∞", "–¥–æ–±—Ä–æ–≥–æ –¥–Ω—è", "–¥–æ–±—Ä–æ–≥–æ –≤–µ—á–µ—Ä–∞",
        "—Ä–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å", "—Ä–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å", "—Å–Ω–æ–≤–∞ —è", "—ç—Ç–æ —è —Å–Ω–æ–≤–∞"
    }
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if lower in exact_greetings:
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ñ—Ä–∞–∑)
    greeting_starts = {
        "–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–¥–æ–±—Ä—ã–π", "–¥–æ–±—Ä–æ–µ", "–¥–æ–±—Ä–æ–π",
        "—Ö–∞–π", "—Ö—ç–π", "—Ö–µ–π", "—Ö–µ–ª–ª–æ", "hello", "hi", "hey", "–π–æ—É", "–∫—É",
        "–∑–¥–æ—Ä–æ–≤–æ", "–∑–¥–∞—Ä–æ–≤–∞", "—Å–∞–ª—é—Ç", "—à–∞–ª–æ–º", "–±–æ–Ω–∂—É—Ä", "—Ö–æ–ª–∞"
    }
    
    first_word = lower.split()[0] if lower.split() else ""
    if first_word in greeting_starts and len(lower.split()) <= 3:
        return True
    
    return False


# --------------------------
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
# --------------------------

def add_emoji_prefix(text: str) -> str:
    return f"{random.choice(CALM_EMOJIS)} {text}"


def get_sad_response() -> str:
    return add_emoji_prefix(random.choice(SAD_RESPONSES))


def get_tired_response() -> str:
    return add_emoji_prefix(random.choice(TIRED_RESPONSES))


def get_anxiety_response() -> str:
    return add_emoji_prefix(random.choice(ANXIETY_RESPONSES))


def get_greeting_response() -> str:
    return add_emoji_prefix(random.choice(GREETING_RESPONSES))


def get_no_joy_response() -> str:
    return add_emoji_prefix(random.choice(NO_JOY_RESPONSES))


def get_joy_response(chat_id: int) -> str:
    if not JOY_RESPONSES:
        return add_emoji_prefix("–ó–∞–ø–∏—Å–∞–ª–∞ —ç—Ç–æ –∫–∞–∫ —Ç–≤–æ—é —Ä–∞–¥–æ—Å—Ç—å.")
    last_idx = LAST_JOY_INDEX.get(chat_id)
    idx = random.randrange(len(JOY_RESPONSES))
    if last_idx is not None and len(JOY_RESPONSES) > 1:
        for _ in range(3):
            if idx != last_idx:
                break
            idx = random.randrange(len(JOY_RESPONSES))
    LAST_JOY_INDEX[chat_id] = idx
    return add_emoji_prefix(JOY_RESPONSES[idx])


# --------------------------
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# --------------------------

def process_incoming_message(update: dict):
    if "message" not in update:
        return
    msg = update["message"]
    chat = msg.get("chat") or {}
    chat_id = chat.get("id")
    if chat_id is None:
        return
    text = msg.get("text", "")
    if not text:
        return

    stripped = text.strip()

    # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞ - –∏–º–µ–µ—Ç –≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
    if stripped.startswith("/cancel"):
        state, _ = get_dialog_state(chat_id)
        clear_dialog_state(chat_id)
        if state in ("await_letter_period", "await_letter_text"):
            send_message(
                chat_id,
                add_emoji_prefix(
                    "–û–∫–µ–π, –ø–∏—Å—å–º–æ —Å–µ–±–µ –ø–æ–∫–∞ –æ—Ç–ª–æ–∂–∏–º. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è ‚Äî –Ω–∞–ø–∏—à–∏ /letter."
                )
            )
        else:
            send_message(
                chat_id,
                add_emoji_prefix(
                    "–û—Ç–º–µ–Ω–∏–ª–∞ —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥. –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–∏—Å–∞—Ç—å —Ä–∞–¥–æ—Å—Ç–∏, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—Ç—Å—è."
                )
            )
        return

    # –ö–æ–º–∞–Ω–¥—ã
    if stripped.startswith("/start"):
        clear_dialog_state(chat_id)
        send_message(
            chat_id,
            "–ü—Ä–∏–≤–µ—Ç. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –∑–∞–º–µ—á–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∞–¥–æ—Å—Ç–∏.\n\n"
            "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å—é–¥–∞ —á—Ç–æ-—Ç–æ –ø—Ä–∏—è—Ç–Ω–æ–µ –∏–∑ –¥–Ω—è: –≤—Å—Ç—Ä–µ—á—É, –≤–∫—É—Å–Ω—ã–π –∫–æ—Ñ–µ, —Å–ø–æ–∫–æ–π–Ω—ã–π –≤–µ—á–µ—Ä.\n"
            "–í 18:00 —è –Ω–∞–ø–æ–º–Ω—é, –µ—Å–ª–∏ —Ç—ã –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∞, –∞ –≤ 21:00 –ø—Ä–∏—à–ª—é –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å.\n\n"
            "–ê –µ—â—ë –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ ‚Äî –¥–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∞ /letter.\n"
            "–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø–æ —Ö–æ–¥—É –¥–∏–∞–ª–æ–≥–∞ –∏–ª–∏ –ø–∏—Å—å–º–∞ —Ç—ã –ø–µ—Ä–µ–¥—É–º–∞–µ—à—å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ /cancel.\n\n"
            "–ú–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —É–∂–µ —Å–µ–π—á–∞—Å: –Ω–∞–ø–∏—à–∏ –æ–¥–Ω—É –º–∞–ª–µ–Ω—å–∫—É—é —Ä–∞–¥–æ—Å—Ç—å –∏–ª–∏ —Ç—ë–ø–ª—ã–π –º–æ–º–µ–Ω—Ç –∏–∑ —ç—Ç–æ–≥–æ –¥–Ω—è."
        )
        return

    if stripped.startswith("/stats"):
        total = get_joy_count(chat_id)
        if total == 0:
            send_message(
                chat_id,
                f"{random.choice(STATS_EMOJIS)} –ü–æ–∫–∞ —É —Ç–µ–±—è –Ω–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π.\n"
                "–ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –æ–¥–Ω–æ–π –Ω–µ–±–æ–ª—å—à–æ–π, –∫–æ–≥–¥–∞ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å —Ä–µ—Å—É—Ä—Å."
            )
        else:
            send_message(
                chat_id,
                f"{random.choice(STATS_EMOJIS)} –£ —Ç–µ–±—è —É–∂–µ {total} –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π!\n"
                "–≠—Ç–æ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å —Ö–æ—Ä–æ—à–µ–µ –≤ —Å–≤–æ–∏—Ö –¥–Ω—è—Ö."
            )
        return

    if stripped.startswith("/letter"):
        handle_letter_command(chat_id)
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞—Ç –î–û –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    if contains_profanity(text):
        send_message(
            chat_id,
            add_emoji_prefix("–ü–æ—Ö–æ–∂–µ, —Å–µ–≥–æ–¥–Ω—è –±—ã–ª —Ç—Ä—É–¥–Ω—ã–π –¥–µ–Ω—å! –ü–æ–Ω–∏–º–∞—é, –Ω–æ –¥–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ —Ä–µ–∑–∫–∏—Ö —Å–ª–æ–≤")
        )
        return

    # –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
    state, meta = get_dialog_state(chat_id)
    
    if state == "await_letter_period":
        handle_letter_period(chat_id, text)
        return
    if state == "await_letter_text":
        handle_letter_text(chat_id, text, meta or {})
        return

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –æ—Ç–≤–µ—á–∞–µ–º, –Ω–æ –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞–¥–æ—Å—Ç—å
    # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–∞–ª–æ —Ä–∞–¥–æ—Å—Ç–µ–π (–ø–µ—Ä–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
    joy_count = get_joy_count(chat_id)
    if joy_count <= 2 and is_greeting_message(stripped):
        send_message(chat_id, get_greeting_response())
        return
    elif is_greeting_message(stripped):
        # –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–∞–∫ —Ä–∞–¥–æ—Å—Ç—å
        # –≤–º–µ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º
        pass

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
    
    if is_severe_sad_message(stripped):
        send_message(
            chat_id,
            add_emoji_prefix(
                "–°–ª—ã—à—É, —á—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ.\n\n"
                "–° —Ç–∞–∫–∏–º–∏ —á—É–≤—Å—Ç–≤–∞–º–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –æ–¥–Ω–æ–π. "
                "–ü–æ—Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —Ç–µ–º, –∫–æ–º—É –¥–æ–≤–µ—Ä—è–µ—à—å: –±–ª–∏–∑–∫–∏–π —á–µ–ª–æ–≤–µ–∫, –¥—Ä—É–≥, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç.\n"
                "–¢—ã –≤–∞–∂–Ω–∞ –∏ –∏–º–µ–µ—à—å –ø—Ä–∞–≤–æ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
            )
        )
        add_sad_event(chat_id)
        return

    if is_anxiety_message(stripped):
        send_message(chat_id, get_anxiety_response())
        add_sad_event(chat_id)
        return

    if is_tired_message(stripped):
        send_message(chat_id, get_tired_response())
        add_sad_event(chat_id)
        return

    if is_sad_message(stripped):
        send_message(chat_id, get_sad_response())
        add_sad_event(chat_id)
        return

    if is_no_joy_message(stripped):
        send_message(chat_id, get_no_joy_response())
        return

    # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - —ç—Ç–æ –æ–±—ã—á–Ω–∞—è —Ä–∞–¥–æ—Å—Ç—å
    cleaned = clean_text_pipeline(text)
    if not cleaned:
        send_message(
            chat_id,
            "–ú–Ω–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∏—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.\n"
            "–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —á—É—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ, —á—Ç–æ —Ç–µ–±—è —Å–µ–≥–æ–¥–Ω—è –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ."
        )
        return

    add_joy(chat_id, cleaned)
    send_message(chat_id, get_joy_response(chat_id))


# --------------------------
# –ü–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ
# --------------------------

def handle_letter_command(chat_id: int):
    clear_dialog_state(chat_id)
    send_message(
        chat_id,
        add_emoji_prefix(
            "–î–∞–≤–∞–π —É—Å—Ç—Ä–æ–∏–º –º–∞–ª–µ–Ω—å–∫–æ–µ –ø–∏—Å—å–º–æ –≤ –±—É–¥—É—â–µ–µ.\n\n"
            "–í—ã–±–µ—Ä–∏, –∫–æ–≥–¥–∞ —Ö–æ—á–µ—à—å –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å:\n"
            "‚Ä¢ 7 ‚Äî —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é\n"
            "‚Ä¢ 14 ‚Äî —á–µ—Ä–µ–∑ –¥–≤–µ –Ω–µ–¥–µ–ª–∏\n"
            "‚Ä¢ 30 ‚Äî —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü\n\n"
            "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Ü–∏—Ñ—Ä—É: 7, 14 –∏–ª–∏ 30.\n"
            "–ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—à—å ‚Äî –Ω–∞–ø–∏—à–∏ /cancel –∏–ª–∏ ¬´–æ—Ç–º–µ–Ω–∞¬ª."
        )
    )
    set_dialog_state(chat_id, "await_letter_period", None)


def handle_letter_period(chat_id: int, text: str):
    if is_cancel_message(text):
        clear_dialog_state(chat_id)
        send_message(
            chat_id,
            add_emoji_prefix(
                "–•–æ—Ä–æ—à–æ, –æ—Ç–ª–æ–∂–∏–º –ø–∏—Å—å–º–æ –≤ –±—É–¥—É—â–µ–µ. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç—Ç–æ–π –∏–¥–µ–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ /letter."
            )
        )
        return

    norm = normalize_text_for_match(text)
    if norm not in ["7", "14", "30"]:
        send_message(
            chat_id,
            add_emoji_prefix(
                "–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞ —Å—Ä–æ–∫.\n"
                "–ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—É: 7, 14 –∏–ª–∏ 30.\n"
                "–ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—à—å ‚Äî –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å /cancel."
            )
        )
        return
    days = int(norm)
    set_dialog_state(chat_id, "await_letter_text", {"days": days})
    send_message(
        chat_id,
        add_emoji_prefix(
            "–•–æ—Ä–æ—à–æ. –ù–∞–ø–∏—à–∏ —Å–µ–π—á–∞—Å –ø–∏—Å—å–º–æ —Å–µ–±–µ ‚Äî —Ç–æ–π, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç —Å—Ä–æ–∫.\n\n"
            "–ú–æ–∂–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å, –∫–∞–∫ —Ç—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–µ–π—á–∞—Å, —á—Ç–æ —Ç–µ–±–µ –≤–∞–∂–Ω–æ, –æ —á—ë–º –º–µ—á—Ç–∞–µ—à—å –∏–ª–∏ —á—Ç–æ —Ö–æ—á–µ—à—å —Å–µ–±–µ –Ω–∞–ø–æ–º–Ω–∏—Ç—å.\n"
            "–ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—à—å ‚Äî –Ω–∞–ø–∏—à–∏ /cancel –∏–ª–∏ ¬´–æ—Ç–º–µ–Ω–∞¬ª."
        )
    )


def handle_letter_text(chat_id: int, text: str, meta: dict):
    if is_cancel_message(text):
        clear_dialog_state(chat_id)
        send_message(
            chat_id,
            add_emoji_prefix(
                "–û–∫–µ–π, –±–µ–∑ –ø–∏—Å—å–º–∞. –ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —ç—Ç–æ–π –∏–¥–µ–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–∑–æ–≤–∏ /letter –µ—â—ë —Ä–∞–∑."
            )
        )
        return

    days = meta.get("days", 7)
    cleaned = text.strip()
    if not cleaned:
        send_message(
            chat_id,
            add_emoji_prefix(
                "–ü–æ—Ö–æ–∂–µ, –ø–∏—Å—å–º–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—É—Å—Ç—ã–º.\n"
                "–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–µ–±—è –∏–∑ –±—É–¥—É—â–µ–≥–æ. –ò–ª–∏ –Ω–∞–ø–∏—à–∏ /cancel, –µ—Å–ª–∏ –ø–æ–∫–∞ –Ω–µ —Ö–æ—á–µ—Ç—Å—è."
            )
        )
        return

    # –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏—è add_future_letter, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–º –∫–∞–∫ —Ä–∞–¥–æ—Å—Ç—å
    add_joy(chat_id, f"–ü–∏—Å—å–º–æ –≤ –±—É–¥—É—â–µ–µ ({days} –¥–Ω–µ–π): {cleaned}")
    clear_dialog_state(chat_id)
    send_message(
        chat_id,
        add_emoji_prefix(
            f"–û—Ç–ª–∏—á–Ω–æ! –°–æ—Ö—Ä–∞–Ω–∏–ª–∞ —Ç–≤–æ—ë –ø–∏—Å—å–º–æ. –ù–∞–ø–æ–º–Ω—é –æ –Ω—ë–º —á–µ—Ä–µ–∑ {days} –¥–Ω–µ–π.\n"
            "–ê –ø–æ–∫–∞ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π –∑–∞–º–µ—á–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∞–¥–æ—Å—Ç–∏ –≤–æ–∫—Ä—É–≥!"
        )
    )


# --------------------------
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –æ—Ç—á—ë—Ç—ã
# --------------------------

def send_reminder(chat_id: int):
    today = date.today()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è
    if has_sent_reminder_today(chat_id, "reminder"):
        return
    
    if not has_joy_for_date(chat_id, today):
        send_message(
            chat_id,
            f"{random.choice(REMINDER_EMOJIS)} –ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–æ–º–∏–Ω–∞—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è —Ç—ã –µ—â—ë –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∞ –Ω–∏ –æ–¥–Ω–æ–π —Ä–∞–¥–æ—Å—Ç–∏.\n"
            "–ú–æ–∂–µ—Ç, —á—Ç–æ-—Ç–æ –≤—Å—ë –∂–µ –±—ã–ª–æ –ø—Ä–∏—è—Ç–Ω—ã–º? –î–∞–∂–µ —Å–∞–º–∞—è –º–∞–ª–µ–Ω—å–∫–∞—è –º–µ–ª–æ—á—å."
        )
        # –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
        mark_reminder_sent(chat_id, "reminder")


def send_daily_report(chat_id: int):
    today = date.today()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç—á—ë—Ç —Å–µ–≥–æ–¥–Ω—è
    if has_sent_reminder_today(chat_id, "report"):
        return
    
    if has_joy_for_date(chat_id, today):
        send_message(
            chat_id,
            f"{random.choice(JOY_EMOJIS)} –í–æ—Ç –∏ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∞—Å—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º–∏ —Ä–∞–¥–æ—Å—Ç—è–º–∏. –°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏!"
        )
    else:
        send_message(
            chat_id,
            f"{random.choice(CALM_EMOJIS)} –î–µ–Ω—å –ø–æ–¥–æ—à—ë–ª –∫ –∫–æ–Ω—Ü—É. –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –Ω–æ–≤—ã–π —à–∞–Ω—Å –∑–∞–º–µ—Ç–∏—Ç—å —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ.\n"
            "–û—Ç–¥—ã—Ö–∞–π –∏ –Ω–∞–±–∏—Ä–∞–π—Å—è —Å–∏–ª."
        )
    
    # –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –æ—Ç—á—ë—Ç –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
    mark_reminder_sent(chat_id, "report")


def daily_scheduler():
    last_reminder_day = None
    last_report_day = None
    
    while True:
        now = datetime.now()
        today = now.date()
        
        # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 18:00
        if now.hour == 18 and now.minute == 0:
            if last_reminder_day != today:  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å
                print(f"DEBUG: Sending reminders at {now}")
                for user_id in get_all_user_ids():
                    try:
                        send_reminder(user_id)
                    except Exception as e:
                        print(f"Error sending reminder to {user_id}: {e}")
                last_reminder_day = today
                time.sleep(61)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –≤ —ç—Ç—É –∂–µ –º–∏–Ω—É—Ç—É
            else:
                time.sleep(30)
        
        # –û—Ç—á—ë—Ç –≤ 21:00
        elif now.hour == 21 and now.minute == 0:
            if last_report_day != today:  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –¥–µ–Ω—å
                print(f"DEBUG: Sending reports at {now}")
                for user_id in get_all_user_ids():
                    try:
                        send_daily_report(user_id)
                    except Exception as e:
                        print(f"Error sending report to {user_id}: {e}")
                last_report_day = today
                time.sleep(61)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –≤ —ç—Ç—É –∂–µ –º–∏–Ω—É—Ç—É
            else:
                time.sleep(30)
        
        else:
            time.sleep(30)


# --------------------------
# MAIN
# --------------------------

def main():
    init_db()
    
    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    scheduler_thread = threading.Thread(target=daily_scheduler, daemon=True)
    scheduler_thread.start()
    
    offset = None
    
    while True:
        try:
            updates = get_updates(offset, POLL_TIMEOUT)
            for update in updates:
                process_incoming_message(update)
                offset = update.get("update_id", 0) + 1
            time.sleep(POLL_SLEEP)
        except Exception as e:
            print(f"Error in main loop: {e}")
            time.sleep(POLL_SLEEP)


if __name__ == "__main__":
    main()
