"""
chudomoodo_bot.py

Telegram-бот "Дневник маленьких радостей".

Функционал:
- принимает от пользователя короткие тексты-радости;
- очищает мат и нецензурную лексику;
- (опционально) исправляет орфографию и пунктуацию через LanguageTool;
- сохраняет радости в SQLite;
- ЕЖЕДНЕВНЫЙ РЕЖИМ:
    - в 18:00 — напоминание, если за день не было ни одной радости;
    - в 21:00 — отчёт с радостями за текущий день;
- защита от тоски: отдельные реакции на грусть, усталость, тревогу, тяжёлые фразы;
- спокойные тексты-ответы с одним эмодзи в начале;
- ачивки за количество радостей и стрики по дням (без упора на цифры в формулировках);
- статистика по команде /stats;
- ритуал «3 маленькие радости», если много грусти (сейчас без отдельных дополнительных сообщений);
- микродиалоги: бот может попросить найти одну маленькую опору;
- персонализация по темам радостей (еда, люди, природа, отдых, успехи);
- недельные и месячные обзоры по-человечески;
- письма себе в будущее по команде /letter (через 7 / 14 / 30 дней);
- возможность отменить письмо или микродиалог командой /cancel или словами "отмена", "я передумала" и т.п.
"""

import os
import time
import sqlite3
import threading
import random
import re
import json
from datetime import datetime, timedelta, date
from typing import List, Tuple, Optional, Dict

import requests

# --------------------------
# CONFIG
# --------------------------

TOKEN = os.getenv("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("Не задан TELEGRAM_TOKEN в переменных окружения.")

API_URL = f"https://api.telegram.org/bot{TOKEN}"
DB_PATH = os.path.join(os.path.dirname(__file__), "joys.db")

POLL_TIMEOUT = 30
POLL_SLEEP = 1

USE_LANGTOOL = False
LANGTOOL_URL = "https://api.languagetool.org/v2/check"

# --------------------------
# Лексика
# --------------------------

# расширенный список нецензурной лексики (сильно увеличен)
BAD_WORDS = [
    "хуй", "хуя", "хую", "хуем", "хуи", "хуёв", "хуев", "хуёвый", "хуевый", "хуёвые",
    "хуевые", "хуёвая", "хуевая", "хуёво", "хуево", "хуиня", "хуйню", "хрен", "хрена",
    "хренов", "хреновый", "хреновая", "хреново", "пизда", "пизды", "пиздец", "пиздеца",
    "пиздецу", "пиздецом", "пиздеть", "пиздит", "пиздишь", "пиздел", "пиздела",
    "пиздануть", "пизданул", "пизданула", "пиздануло", "пиздатый", "пиздатая", "пиздато",
    "пиздёж", "пизд
