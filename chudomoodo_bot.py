"""
chudomoodo_bot.py

Telegram-–±–æ—Ç "–î–Ω–µ–≤–Ω–∏–∫ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π".

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã-—Ä–∞–¥–æ—Å—Ç–∏;
- –æ—á–∏—â–∞–µ—Ç –º–∞—Ç –∏ –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—É—é –ª–µ–∫—Å–∏–∫—É (–≤–Ω–µ—à–Ω–∏–π —Ñ–∞–π–ª bad_words.txt + —Å—á—ë—Ç—á–∏–∫ –º–∞—Ç–∞);
- —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–∞–¥–æ—Å—Ç–∏ –≤ SQLite;
- —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –±–∞–∑–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è: —Ä–∞–¥–æ—Å—Ç—å / –≥—Ä—É—Å—Ç—å / —É—Å—Ç–∞–ª–æ—Å—Ç—å / —Ç—Ä–µ–≤–æ–≥—É / —Ç—è–∂—ë–ª—ã–µ —Ñ—Ä–∞–∑—ã;
- —Ö—Ä–∞–Ω–∏—Ç —ç–º–æ—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø—Ä–æ—Å—Ç—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Ä–∞–¥–æ—Å—Ç–µ–π (—Ç–µ–º—ã);
- –ï–ñ–ï–î–ù–ï–í–ù–´–ô –†–ï–ñ–ò–ú:
    - –≤ 19:00 ‚Äî –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞ –¥–µ–Ω—å –Ω–µ –±—ã–ª–æ –Ω–∏ –æ–¥–Ω–æ–π —Ä–∞–¥–æ—Å—Ç–∏;
    - –≤ 22:00 ‚Äî –æ—Ç—á—ë—Ç —Å —Ä–∞–¥–æ—Å—Ç—è–º–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å;
- –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–´–ô –†–ï–ñ–ò–ú:
    - –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 22:15 ‚Äî —Ç—ë–ø–ª–∞—è —Å–≤–æ–¥–∫–∞ –Ω–µ–¥–µ–ª–∏ –ø–æ —Ç–µ–º–∞–º —Ä–∞–¥–æ—Å—Ç–µ–π;
- –ø–∏—Å—å–º–∞ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /letter (–¥–æ—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π);
- –∑–∞—â–∏—Ç–∞ –æ—Ç —Ç–æ—Å–∫–∏: –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –≥—Ä—É—Å—Ç—å, —É—Å—Ç–∞–ª–æ—Å—Ç—å, —Ç—Ä–µ–≤–æ–≥—É, —Ç—è–∂—ë–ª—ã–µ —Ñ—Ä–∞–∑—ã;
- —Å–ø–æ–∫–æ–π–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã-–æ—Ç–≤–µ—Ç—ã —Å –æ–¥–Ω–∏–º —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ;
- –∞—á–∏–≤–∫–∏ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–¥–æ—Å—Ç–µ–π –∏ —Å—Ç—Ä–∏–∫–∏ –ø–æ –¥–Ω—è–º;
- —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ /stats (—Ç–µ–º—ã –∏ —ç–º–æ—Ü–∏–∏ –±–µ–∑ —Ü–∏—Ñ—Ä);
- /export ‚Äî —ç–∫—Å–ø–æ—Ä—Ç —Ä–∞–¥–æ—Å—Ç–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.
"""

import os
import time
import sqlite3
import threading
import random
from datetime import datetime, timedelta, date
from typing import List, Tuple, Optional, Dict

import requests

# --------------------------
# CONFIG
# --------------------------

TOKEN = os.getenv("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω TELEGRAM_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

API_URL = f"https://api.telegram.org/bot{TOKEN}"

DB_PATH = os.path.join(os.path.dirname(__file__), "joys.db")

POLL_TIMEOUT = 30
POLL_SLEEP = 1

USE_LANGTOOL = False
LANGTOOL_URL = "https://api.languagetool.org/v2/check"


# --------------------------
# –ü–ª–æ—Ö–∏–µ —Å–ª–æ–≤–∞
# --------------------------

def load_bad_words() -> List[str]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –º–∞—Ç–∞ –∏–∑ bad_words.txt (–æ–¥–∏–Ω —Ç–µ—Ä–º–∏–Ω –≤ —Å—Ç—Ä–æ–∫–µ).
    –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –∏–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–±–æ–ª—å—à–æ–π –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫.
    """
    default_words = [
        "—Ö—É–π", "—Ö—É–∏", "—Ö–µ—Ä", "–ø–∏–∑–¥–∞", "–µ–±–∞—Ç—å", "–µ–±–∞–Ω", "—Å—É–∫–∞", "–±–ª—è–¥", "–±–ª—è",
    ]

    path = os.path.join(os.path.dirname(__file__), "bad_words.txt")
    words: List[str] = []

    try:
        with open(path, "r", encoding="utf-8") as f:
            for line in f:
                w = line.strip().lower()
                if not w or w.startswith("#"):
                    continue
                words.append(w)
    except FileNotFoundError:
        return default_words

    return words or default_words


BAD_WORDS = load_bad_words()


def contains_profanity(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –º–∞—Ç/–±—Ä–∞–Ω—å –≤ —Ç–µ–∫—Å—Ç–µ."""
    lower = text.lower()
    return any(bad in lower for bad in BAD_WORDS)


# --------------------------
# –õ–µ–∫—Å–∏–∫–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
# --------------------------

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≥—Ä—É—Å—Ç–Ω—ã–π –±–ª–æ–∫
SAD_PATTERNS = [
    # –ü—Ä–æ –¥–µ–Ω—å
    "–ø–ª–æ—Ö–æ–π –¥–µ–Ω—å", "—É–∂–∞—Å–Ω—ã–π –¥–µ–Ω—å", "—Ç—è–∂—ë–ª—ã–π –¥–µ–Ω—å", "—Ç—è–∂–µ–ª—ã–π –¥–µ–Ω—å",
    "–¥–µ–Ω—å –≥–æ–≤–Ω–æ", "–¥–µ–Ω—å –±—ã–ª —Ç–∞–∫ —Å–µ–±–µ", "–¥–µ–Ω—å –±—ã–ª —É–∂–∞—Å–Ω—ã–π", "–¥–µ–Ω—å –Ω–µ –∑–∞–¥–∞–ª—Å—è",
    "–Ω–µ—É–¥–∞—á–Ω—ã–π –¥–µ–Ω—å", "–¥–µ–Ω—å –Ω–µ –æ—á–µ–Ω—å", "–¥–µ–Ω—å –æ—Ç—Å—Ç–æ–π", "–æ—Ç—Å—Ç–æ–π–Ω—ã–π –¥–µ–Ω—å",

    # –°–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äú–Ω–∏—á–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ‚Äù
    "–Ω–∏—á–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ", "–Ω–∏—á–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ –Ω–µ –±—ã–ª–æ", "–Ω–∏—á–µ–≥–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ",
    "–Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–¥—É–µ—Ç", "–Ω–∏—á—Ç–æ –Ω–µ —Ä–∞–¥—É–µ—Ç",
    "–Ω–µ —Ä–∞–¥–æ–≤–∞–ª–æ", "–Ω–µ –∑–∞ —á—Ç–æ –∑–∞—Ü–µ–ø–∏—Ç—å—Å—è",

    # –ü–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ / –∞–ø–∞—Ç–∏—è
    "–≥—Ä—É—Å—Ç–Ω–æ", "–ø–µ—á–∞–ª—å–Ω–æ", "–º–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ", "—è –≥—Ä—É—â—É",
    "—Ç–æ—Å–∫–ª–∏–≤–æ", "—Ç–æ—Å–∫–∞", "—Ç–µ–ø–µ—Ä—å –≥—Ä—É—Å—Ç–Ω–æ",
    "–ø–æ–¥–∞–≤–ª–µ–Ω–æ", "–ø–æ–¥–∞–≤–ª–µ–Ω", "–ø–æ–¥–∞–≤–ª–µ–Ω–∞",
    "–∞–ø–∞—Ç–∏—è", "–∞–ø–∞—Ç–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
    "–Ω–µ —Ö–æ—á—É –Ω–∏—á–µ–≥–æ", "–Ω–∏—á–µ–≥–æ –Ω–µ —Ö–æ—á–µ—Ç—Å—è", "–Ω–µ—Ç –∂–µ–ª–∞–Ω–∏—è",
    "–ø—Ä–æ—Å—Ç–æ –ø—É—Å—Ç–æ", "–ø—É—Å—Ç–æ –Ω–∞ –¥—É—à–µ",
    "–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–æ–ª—å", "–Ω–æ–ª—å —ç–º–æ—Ü–∏–π", "–Ω–µ—Ç —ç–º–æ—Ü–∏–π",

    # –°–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∞ –∏ –æ—â—É—â–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–∞
    "—è –Ω–∏–∫—á—ë–º–Ω–∞—è", "—è –Ω–∏–∫—á–µ–º–Ω–∞—è", "—è –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ç–æ—é",
    "—è –ø–æ–¥–≤–µ–ª–∞", "—è –≤—Å–µ—Ö –ø–æ–¥–≤–µ–ª–∞", "—è –æ–±–ª–∞–∂–∞–ª–∞—Å—å", "—è –æ–±–ª–∞–∂–∞–ª—Å—è",
    "—è –Ω–µ —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å", "—è –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è",
    "—É –º–µ–Ω—è –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è", "–≤—Å—ë –≤–∞–ª–∏—Ç—Å—è –∏–∑ —Ä—É–∫", "–≤—Å–µ –≤–∞–ª–∏—Ç—Å—è –∏–∑ —Ä—É–∫",
    "–∫–∞–∫ –±—É–¥—Ç–æ —è –ø–ª–æ—Ö–∞—è", "–∫–∞–∫ –±—É–¥—Ç–æ —è –ø–ª–æ—Ö–æ–π",

    # –û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ
    "—è –æ–¥–Ω–∞", "—è –æ–¥–∏–Ω", "–Ω–∏–∫–æ–≥–æ –Ω–µ—Ç —Ä—è–¥–æ–º", "–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ",
    "—è –Ω–∏–∫–æ–º—É –Ω–µ –Ω—É–∂–Ω–∞", "—è –Ω–∏–∫–æ–º—É –Ω–µ –Ω—É–∂–µ–Ω",

    # –ù–µ–≥–∞—Ç–∏–≤ –∫ —Å–µ–±–µ –∏ —Ç–µ–ª—É
    "—è —É–∂–∞—Å–Ω–∞—è", "—è —É—Ä–æ–¥", "—è –ø–ª–æ—Ö–∞—è", "—è –ø–ª–æ—Ö–æ–π",
    "—è —Ç—É–ø–∞—è", "—è —Ç—É–ø–æ–π",

    # –û–±—â–∞—è –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è –æ–∫—Ä–∞—Å–∫–∞
    "–≤—Å—ë –ø–ª–æ—Ö–æ", "–≤—Å–µ –ø–ª–æ—Ö–æ", "–ø–æ–ª–Ω—ã–π –æ—Ç—Å—Ç–æ–π",
    "–≤—Å—ë –±–µ—Å–∏—Ç", "–≤—Å–µ –±–µ—Å–∏—Ç", "–≤—Å–µ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç",
    "—É–∂–∞—Å", "–æ—Ç—Å—Ç–æ–π", "–∫–æ—à–º–∞—Ä",
    "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω", "—Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∞",
    "—Ö—Ä–µ–Ω–æ–≤–æ", "–ø–∞—Ä—à–∏–≤–æ", "–≥–∞–¥–∫–æ",
    "–∏—Å—á–µ–∑–ª–∞ —Ä–∞–¥–æ—Å—Ç—å", "–Ω–µ—Ç —Ä–∞–¥–æ—Å—Ç–∏",

    # –£—Å—Ç–∞–ª–æ—Å—Ç—å + –≥—Ä—É—Å—Ç—å
    "—Å–∏–ª –Ω–µ—Ç", "–Ω–µ—Ç —Å–∏–ª", "—É—Å—Ç–∞–ª–∞ –¥—É—à–æ–π", "—É—Å—Ç–∞–ª –¥—É—à–æ–π",
    "–Ω–µ –≤ —Ä–µ—Å—É—Ä—Å–µ", "—è –≤—ã–º–æ—Ç–∞–ª–∞—Å—å", "—è –≤—ã–º–æ—Ç–∞–ª—Å—è",

    # –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ ‚Äú–Ω–µ —á—É–≤—Å—Ç–≤—É—é‚Ä¶‚Äù
    "–Ω–µ —á—É–≤—Å—Ç–≤—É—é —Ä–∞–¥–æ—Å—Ç–∏", "–Ω–µ —á—É–≤—Å—Ç–≤—É—é —Å—á–∞—Å—Ç—å—è",
    "–Ω–∏—á–µ–≥–æ –Ω–µ —á—É–≤—Å—Ç–≤—É—é",
]

# –£—Å—Ç–∞–ª–æ—Å—Ç—å
TIRED_PATTERNS = [
    # —É—Å—Ç–∞–ª–æ—Å—Ç—å –ø—Ä—è–º—ã–º —Ç–µ–∫—Å—Ç–æ–º
    "—É—Å—Ç–∞–ª–∞", "—É—Å—Ç–∞–ª", "–æ—á–µ–Ω—å —É—Å—Ç–∞–ª–∞", "–æ—á–µ–Ω—å —É—Å—Ç–∞–ª",
    "—è —Ç–∞–∫ —É—Å—Ç–∞–ª–∞", "—è —Ç–∞–∫ —É—Å—Ç–∞–ª",
    "—Å–∏–ª –Ω–µ—Ç", "–Ω–µ—Ç —Å–∏–ª", "–Ω–∏ –Ω–∞ —á—Ç–æ –Ω–µ—Ç —Å–∏–ª",
    "–∏—Å—Ç–æ—â–µ–Ω–∞", "–∏—Å—Ç–æ—â–µ–Ω",
    "–≤—ã–º–æ—Ç–∞–ª–∞—Å—å", "–≤—ã–º–æ—Ç–∞–ª—Å—è", "—è –≤—ã–º–æ—Ç–∞–ª–∞—Å—å", "—è –≤—ã–º–æ—Ç–∞–ª—Å—è",
    "–≤—ã–≥–æ—Ä–µ–ª–∞", "–≤—ã–≥–æ—Ä–µ–ª", "—è –≤—ã–≥–æ—Ä–µ–ª–∞", "—è –≤—ã–≥–æ—Ä–µ–ª",
    "–º–Ω–µ —Ç—è–∂–µ–ª–æ", "–æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ", "–µ–ª–µ –¥–µ—Ä–∂—É—Å—å",

    # —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å
    "–æ–ø—É—Å—Ç–æ—à–µ–Ω–∞", "–æ–ø—É—Å—Ç–æ—à–µ–Ω",
    "—É –º–µ–Ω—è –Ω–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤", "–Ω–µ –≤ —Ä–µ—Å—É—Ä—Å–µ", "—Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–æ–ª—å",

    # —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    "—Å–ø–∞—Ç—å —Ö–æ—á—É", "—è –∫–∞–∫ –≤—ã–∂–∞—Ç—ã–π –ª–∏–º–æ–Ω", "—Ä–∞–∑–≤–∞–ª–∏–≤–∞—é—Å—å",
    "—Ä–∞–∑–±–∏—Ç–∞—è", "—Ä–∞–∑–±–∏—Ç—ã–π",

    # –±—ã—Ç–æ–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
    "–±–∞—Ç–∞—Ä–µ–π–∫–∞ –Ω–∞ –Ω—É–ª–µ", "–≤ –Ω–æ–ª—å", "–Ω–∞ –Ω—É–ª–µ",
    "—Ö–æ—á—É –ª–µ–∂–∞—Ç—å", "–ª–µ–∂–∞—Ç—å –∏ –Ω–µ –≤—Å—Ç–∞–≤–∞—Ç—å",
]

# –¢—Ä–µ–≤–æ–≥–∞
ANXIETY_PATTERNS = [
    # —Å—Ç—Ä–∞—Ö –∏ —Ç—Ä–µ–≤–æ–≥–∞
    "—Å—Ç—Ä–∞—à–Ω–æ", "–º–Ω–µ —Å—Ç—Ä–∞—à–Ω–æ", "—è –±–æ—é—Å—å", "—è –æ—á–µ–Ω—å –±–æ—é—Å—å",
    "—è –ø–µ—Ä–µ–∂–∏–≤–∞—é", "–ø–µ—Ä–µ–∂–∏–≤–∞—é", "–≤–æ–ª–Ω—É–µ—Ç",
    "—Ç—Ä–µ–≤–æ–∂–Ω–æ", "—Ç—Ä–µ–≤–æ–≥–∞", "–ø–∞–Ω–∏–∫–∞", "–ø–∞–Ω–∏–∫—É—é", "–ø–∞–Ω–∏—á–µ—Å–∫–∞—è –∞—Ç–∞–∫–∞",

    # —Å–æ–º–Ω–µ–Ω–∏—è –≤ —Å–µ–±–µ
    "—è –Ω–µ —É–≤–µ—Ä–µ–Ω–∞", "—è –Ω–µ —É–≤–µ—Ä–µ–Ω", "—Å–æ–º–Ω–µ–≤–∞—é—Å—å",
    "–≤–¥—Ä—É–≥ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è", "–≤–¥—Ä—É–≥ –≤—Å—ë –Ω–µ —Ç–∞–∫", "–≤–¥—Ä—É–≥ –≤—Å–µ –Ω–µ —Ç–∞–∫",
    "—è –≤—Å—ë –∏—Å–ø–æ—Ä—Ç–∏–ª–∞", "—è –≤—Å–µ –∏—Å–ø–æ—Ä—Ç–∏–ª–∞", "—è –≤—Å—ë –∏—Å–ø–æ—Ä—Ç–∏–ª", "—è –≤—Å–µ –∏—Å–ø–æ—Ä—Ç–∏–ª",

    # —á—É–≤—Å—Ç–≤–æ –Ω–∞–¥–≤–∏–≥–∞—é—â–µ–π—Å—è –ø—Ä–æ–±–ª–µ–º—ã
    "–∫–∞–∂–µ—Ç—Å—è –≤—Å–µ –∏–¥–µ—Ç –Ω–µ —Ç–∞–∫", "–∫–∞–∂–µ—Ç—Å—è –≤—Å—ë –∏–¥–µ—Ç –Ω–µ —Ç–∞–∫",
    "—á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫", "—á—Ç–æ —Ç–æ –Ω–µ —Ç–∞–∫",
    "–Ω–µ –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—Ç—å", "–Ω–µ —Å–ø—Ä–∞–≤–ª—é—Å—å", "–Ω–µ –ø–æ—Ç—è–Ω—É",

    # —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ç—Ä–µ–≤–æ–≥–∞
    "—Å–µ—Ä–¥—Ü–µ –∫–æ–ª–æ—Ç–∏—Ç—Å—è", "—Ç—Ä—è—Å—Ç–∏ –Ω–∞—á–∞–ª–æ", "–¥—ã—à–∞—Ç—å —Ç—è–∂–µ–ª–æ",
]

# –¢—è–∂—ë–ª—ã–µ —Ñ—Ä–∞–∑—ã
SEVERE_SAD_PATTERNS = [
    "–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å",
    "–Ω–µ —Ö–æ—á—É –±–æ–ª—å—à–µ –∂–∏—Ç—å",
    "–Ω–µ—Ç —Å–º—ã—Å–ª–∞ –∂–∏—Ç—å",
    "–Ω–µ –≤–∏–∂—É —Å–º—ã—Å–ª–∞",
    "–∂–∏–∑–Ω—å –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞",
    "–Ω–µ–Ω–∞–≤–∏–∂—É —Å–≤–æ—é –∂–∏–∑–Ω—å",
    "—Ö–æ—á—É —É–º–µ—Ä–µ—Ç—å",
    "–ª—É—á—à–µ –±—ã –º–µ–Ω—è –Ω–µ –±—ã–ª–æ",
]

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
GREETING_PATTERNS = [
    # –±–∞–∑–æ–≤—ã–µ
    "–ø—Ä–∏–≤–µ—Ç", "–ø—Ä–∏–≤–µ—Ç!", "–ø—Ä–∏–≤–µ—Ç)", "–ø—Ä–∏–≤–µ—Ç))", "–ø—Ä–∏–≤–µ—Ç–∏–∫", "–ø—Ä–∏–≤–µ—Ç–∏–∫!",
    "–ø—Ä–∏–≤–µ—Ç–∏–∫–∏",
    "—Ö–∞–π", "—Ö–∞–π!", "—Ö–∞–π))",
    "—Ö–µ–ª–ª–æ", "—Ö–µ–ª–ª–æ!", "—Ö–µ–ª–ª–æ—É", "—Ö–µ–ª–ª–æ—É!",
    "hi", "hi!", "hello", "hello!",

    # –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ
    "–∫—É", "–∫—É!", "–∫—É–∫—É", "–∫—É-–∫—É",
    "–π–æ—É", "–π–æ—É!", "–π–æ", "–π–æ!",
    "—Ö–µ–π", "—Ö–µ–π!", "—ç–π", "—ç–π!",

    # ‚Äú–∑–¥–æ—Ä–æ–≤‚Äù –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ
    "–∑–¥–æ—Ä–æ–≤–æ", "–∑–¥–∞—Ä–æ–≤–∞", "–∑–¥–∞—Ä–æ–≤–∞!", "–∑–¥–æ—Ä–æ–≤–∞", "–¥–∞—Ä–æ–≤", "–¥–∞—Ä–æ–≤–∞",
    "–∑–¥—Ä–∞—Å—å—Ç–µ", "–∑–¥—Ä–∞—Å—Ç–µ", "–∑–¥—Ä–∞—Å—Ç–µ!",

    # –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ
    "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ",

    # —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
    "–ø—Ä–∏–≤–µ—Ç, –±–æ—Ç", "–ø—Ä–∏–≤–µ—Ç –±–æ—Ç", "–ø—Ä–∏–≤–µ—Ç, –¥–Ω–µ–≤–Ω–∏–∫", "–ø—Ä–∏–≤–µ—Ç –¥–Ω–µ–≤–Ω–∏–∫",
    "–ø—Ä–∏–≤–µ—Ç, –ø–æ–¥—Ä—É–∂–∫–∞", "–ø—Ä–∏–≤–µ—Ç –ø–æ–¥—Ä—É–∂–∫–∞",
    "–ø—Ä–∏–≤–µ—Ç, –¥—Ä—É–≥", "–ø—Ä–∏–≤–µ—Ç –¥—Ä—É–≥",

    # –∫–æ—Ä–æ—Ç–∫–∏–µ
    "–ø—Ä–∏–≤", "–ø—Ä–∏–≤!", "–ø—Ä–∏–≤))", "–ø—Ä–∏–≤)", "–ø—Ä–∏–≤–µ–µ—Ç", "–ø—Ä–∏–≤–µ–µ–µ—Ç",
    "—Ö–∞—é—à–∫–∏", "–¥–æ–±—Ä–æ–≥–æ", "–¥–æ–±—Ä–æ–≥–æ –¥–Ω—è", "–¥–æ–±—Ä–æ–≥–æ –≤–µ—á–µ—Ä–∞",

    # –∞–Ω–≥–ª–æ-—Ä—É—Å—Å–∫–∏–π
    "hi, bot", "hi bot", "hello, bot", "hello bot",
    "hi joy", "hello joy",

    # –∏–≥—Ä–∏–≤—ã–µ
    "—á—É–¥–æ, –ø—Ä–∏–≤–µ—Ç", "—ç–π, —á—É–¥–æ", "—ç–π —á—É–¥–æ", "—ç–π, –¥–Ω–µ–≤–Ω–∏–∫",
    "–ø—Ä–∏–≤–µ—Ç, —ç—Ç–æ —è", "–ø—Ä–∏–≤–µ—Ç, —è –≤–µ—Ä–Ω—É–ª–∞—Å—å", "—è –≤–µ—Ä–Ω—É–ª–∞—Å—å", "—è —Å–Ω–æ–≤–∞ —Ç—É—Ç",

    # –±—ã—Ç–æ–≤—ã–µ
    "–∑–¥–∞—Ä–æ–≤–∞ –±–æ—Ç", "–∑–¥–æ—Ä–æ–≤ –±–æ—Ç", "–∑–¥–æ—Ä–æ–≤–∞ –±–æ—Ç",
    "–∑–¥–∞—Ä–æ–≤", "–Ω—É –ø—Ä–∏–≤–µ—Ç",
    "–Ω—É –∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–Ω—É –ø—Ä–∏–≤–µ—Ç–∏–∫",

    # —Å —É—Å—Ç–∞–ª–æ—Å—Ç—å—é, –Ω–æ –∫–∞–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    "–ø—Ä–∏–≤–µ—Ç, —è —É—Å—Ç–∞–ª–∞", "–ø—Ä–∏–≤–µ—Ç, —è —Å–∏–ª—å–Ω–æ —É—Å—Ç–∞–ª–∞",
    "–ø—Ä–∏–≤–µ—Ç, —á—Ç–æ-—Ç–æ –¥–µ–Ω—å —Ç–∞–∫ —Å–µ–±–µ", "–ø—Ä–∏–≤–µ—Ç, –¥–µ–Ω—å —Ç—è–∂—ë–ª—ã–π", "–ø—Ä–∏–≤–µ—Ç, –¥–µ–Ω—å —Ç—è–∂–µ–ª—ã–π",
]

GREETING_RESPONSES = [
    "–ü—Ä–∏–≤–µ—Ç. –†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ö–æ—Ç—å –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–∏—è—Ç–Ω—ã–º.",
    "–ü—Ä–∏–≤–µ—Ç. –î–∞–≤–∞–π –≤—Å–ø–æ–º–Ω–∏–º, —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–æ —Ç–µ–ø–ª–∞ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.",
    "–ü—Ä–∏–≤–µ—Ç, —è –Ω–∞ —Å–≤—è–∑–∏. –ß—Ç–æ —Ö–æ—Ä–æ—à–µ–≥–æ –±—ã–ª–æ –≤ —ç—Ç–æ–º –¥–Ω–µ?",
    "–†–∞–¥–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –Ω–∞–ø–∏—à–∏ –æ–¥–Ω—É –º–∞–ª–µ–Ω—å–∫—É—é —Ä–∞–¥–æ—Å—Ç—å.",
    "–ü—Ä–∏–≤–µ—Ç. –ú–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å —Å–∞–º–æ–π –ø—Ä–æ—Å—Ç–æ–π –≤–µ—â–∏, –∫–æ—Ç–æ—Ä–∞—è —Ç–µ–±—è –ø–æ–¥–¥–µ—Ä–∂–∞–ª–∞.",
]

JOY_EMOJIS = ["‚ú®", "üòä", "üåà", "üíõ", "üåü"]
REMINDER_EMOJIS = ["‚ú®", "üìå", "üòä"]
STATS_EMOJIS = ["üìä", "üìà", "‚≠ê"]
CALM_EMOJIS = ["üôÇ", "üåø", "‚ú®", "‚òï", "üïä", "üçÉ"]

# –°—Ç–æ–ø-—Å–ª–æ–≤–∞ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
STOPWORDS = {
    "–∏", "–Ω–æ", "–∞", "—á—Ç–æ", "—ç—Ç–æ", "–∫–∞–∫", "–∫–æ–≥–¥–∞", "—è", "–º—ã", "–æ–Ω", "–æ–Ω–∞", "–æ–Ω–∏",
    "–≤", "–Ω–∞", "–Ω–∞–¥", "–ø–æ–¥", "–ø—Ä–æ", "–ø–æ", "–∑–∞", "–∏–∑", "—É", "—Å", "—Å–æ",
    "—Ç–æ", "–∂–µ", "–∏–ª–∏", "—Ç–∞–∫", "–µ—â—ë", "–µ—â–µ", "–±—ã", "–ª–∏", "—Ç—É—Ç", "—Ç–∞–º",
    "–≤–µ—Å—å", "–≤—Å–µ", "–≤—Å—é", "–º–æ–π", "–º–æ—è", "–º–æ–∏", "—Ç–≤–æ–π", "—Ç–≤–æ—è", "—Ç–≤–æ–∏",
}

# –¢–µ–º—ã —Ä–∞–¥–æ—Å—Ç–µ–π –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –Ω–∏—Ö
JOY_THEMES = {
    "–µ–¥–∞": [
        "–∫–æ—Ñ–µ", "—á–∞–π", "–ª–∞—Ç—Ç–µ", "–∫–∞–ø—É—á–∏–Ω–æ", "–∞–º–µ—Ä–∏–∫–∞–Ω–æ",
        "–∫–∞–∫–∞–æ", "–≥–æ—Ä—è—á–∏–π —à–æ–∫–æ–ª–∞–¥",
        "—à–æ–∫–æ–ª–∞–¥", "—à–æ–∫–æ–ª–∞–¥–∫–∞", "–∫–æ–Ω—Ñ–µ—Ç–∞", "–∫–æ–Ω—Ñ–µ—Ç—ã",
        "–ø–µ—á–µ–Ω—å–µ", "–ø–µ—á–µ–Ω—å–∫–∏", "–±—É–ª–æ—á–∫–∞", "–±—É–ª–æ—á–∫–∏",
        "–∫—Ä—É–∞—Å—Å–∞–Ω", "–∫—Ä—É–∞—Å—Å–∞–Ω—ã",
        "–ø–∏—Ä–æ–≥", "–ø–∏—Ä–æ–∂–æ–∫", "–ø–∏—Ä–æ–∂–∫–∏", "—Ç–æ—Ä—Ç", "—Ç–æ—Ä—Ç–∏–∫", "–¥–µ—Å–µ—Ä—Ç",
        "—Å—ã—Ä–Ω–∏–∫–∏", "–±–ª–∏–Ω—á–∏–∫–∏", "–±–ª–∏–Ω—ã", "–æ–ª–∞–¥—å–∏",
        "–ø–∏—Ü—Ü–∞", "–±—É—Ä–≥–µ—Ä", "–±—É—Ä–≥–µ—Ä—ã",
        "—Å—É—à–∏", "—Ä–æ–ª–ª—ã",
        "–æ–±–µ–¥", "–∑–∞–≤—Ç—Ä–∞–∫", "—É–∂–∏–Ω", "–ª–∞–Ω—á",
        "–≤–∫—É—Å–Ω–æ", "–≤–∫—É—Å–Ω—è—Ç–∏–Ω–∞", "–≤–∫—É—Å–Ω—è—à–∫–∞",
        "–∫–∞—Ñ–µ", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "–∫–æ—Ñ–µ–π–Ω—è",
        "—Ñ—Ä—É–∫—Ç—ã", "—è–±–ª–æ–∫–æ", "–±–∞–Ω–∞–Ω", "–∫–ª—É–±–Ω–∏–∫–∞", "—è–≥–æ–¥—ã",
    ],
    "–ª—é–¥–∏": [
        "–¥—Ä—É–≥", "–ø–æ–¥—Ä—É–≥–∞", "–¥—Ä—É–∑—å—è", "–ø–æ–¥—Ä—É–∂–∫–∞", "–ø–æ–¥—Ä—É–∂–∫–∏",
        "–≤—Å—Ç—Ä–µ—á–∞", "–≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å", "–≤—Å—Ç—Ä–µ—Ç–∏–ª–∞—Å—å", "–≤—Å—Ç—Ä–µ—Ç–∏–ª—Å—è",
        "–ø–æ–∑–≤–æ–Ω–∏–ª–∏", "–ø–æ–∑–≤–æ–Ω–∏–ª–∞", "–ø–æ–∑–≤–æ–Ω–∏–ª", "–∑–≤–æ–Ω–æ–∫",
        "–ø–µ—Ä–µ–ø–∏—Å–∫–∞", "–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª–∏—Å—å", "–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–ª–∞—Å—å",
        "–æ–±—â–µ–Ω–∏–µ", "–ø–æ–±–æ–ª—Ç–∞–ª–∏", "–±–æ–ª—Ç–∞–ª–∏", "–±–æ–ª—Ç—É—à–∫–∞",
        "–º–∞–º–∞", "–ø–∞–ø–∞", "—Ä–æ–¥–∏—Ç–µ–ª–∏", "—Å–µ–º—å—è",
        "—Å–µ—Å—Ç—Ä–∞", "–±—Ä–∞—Ç",
        "–∫–æ–ª–ª–µ–≥–∞", "–∫–æ–ª–ª–µ–≥–∏",
        "–Ω–∞—á–∞–ª—å–Ω–∏–∫", "—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", "—à–µ—Ñ",
        "–ø–∞—Ä–µ–Ω—å", "–º—á", "–º—É–∂", "–º—É–∂—á–∏–Ω–∞",
        "–¥–µ–≤—É—à–∫–∞", "–∂–µ–Ω–∞",
        "—Ä–µ–±—ë–Ω–æ–∫", "—Ä–µ–±–µ–Ω–æ–∫", "–¥–µ—Ç–∏", "—Å—ã–Ω", "–¥–æ—á—å",
        "–∫–æ–º–ø–∞–Ω–∏—è", "—Ç—É—Å–æ–≤–∫–∞", "–ø–æ—Å–∏–¥–µ–ª–∏",
        "–æ–±–Ω—è–ª–∏", "–æ–±–Ω—è–ª", "–æ–±–Ω—è–ª–∞", "–æ–±–Ω–∏–º–∞—à–∫–∏",
        "–ø–æ–¥–¥–µ—Ä–∂–∞–ª", "–ø–æ–¥–¥–µ—Ä–∂–∞–ª–∞", "–ø–æ–¥–¥–µ—Ä–∂–∫–∞",
    ],
    "–ø—Ä–∏—Ä–æ–¥–∞": [
        "—Å–æ–ª–Ω—Ü–µ", "—Å–æ–ª–Ω—ã—à–∫–æ", "—Å–æ–ª–Ω–µ—á–Ω–æ", "—Å–æ–ª–Ω–µ—á–Ω—ã–π",
        "–ø–æ–≥–æ–¥–∞", "–∫–ª–∞—Å—Å–Ω–∞—è –ø–æ–≥–æ–¥–∞", "—Ö–æ—Ä–æ—à–∞—è –ø–æ–≥–æ–¥–∞",
        "–Ω–µ–±–æ", "–æ–±–ª–∞–∫–∞", "–∑–≤–µ–∑–¥—ã", "–∑–≤—ë–∑–¥—ã",
        "–ª—É–Ω–∞", "–≤–µ—Ç–µ—Ä", "–≤–µ—Ç–µ—Ä–æ–∫", "–±—Ä–∏–∑",
        "–ª–µ—Å", "–¥–µ—Ä–µ–≤—å—è", "–∑–µ–ª–µ–Ω—å", "—Ç—Ä–∞–≤–∞",
        "–ø–∞—Ä–∫", "—Å–∫–≤–µ—Ä", "—Å–∞–¥",
        "–º–æ—Ä–µ", "–æ–∫–µ–∞–Ω", "—Ä–µ–∫–∞", "–æ–∑–µ—Ä–æ",
        "–ø–ª—è–∂", "–ø–µ—Å–æ–∫",
        "–ø—Ç–∏—á–∫–∏", "–ø—Ç–∏—Ü—ã", "–ø–µ–Ω–∏–µ –ø—Ç–∏—Ü",
        "—Ü–≤–µ—Ç—ã", "–±—É–∫–µ—Ç", "—Ü–≤–µ—Ç–æ—á–µ–∫",
        "–ª–∏—Å—Ç—å—è", "–æ—Å–µ–Ω—å", "–≤–µ—Å–Ω–∞", "–ª–µ—Ç–æ", "–∑–∏–º–∞",
        "—Å–Ω–µ–≥", "—Å–Ω–µ–∂–æ–∫", "—Å–Ω–µ–≥–æ–ø–∞–¥",
        "—Ç—É–º–∞–Ω", "—Ä–∞–¥—É–≥–∞",
        "–ø—Ä–æ–≥—É–ª–∫–∞", "–≥—É–ª—è–ª–∞", "–≥—É–ª—è–ª", "–ø–æ–≥—É–ª—è–ª–∏",
    ],
    "–æ—Ç–¥—ã—Ö": [
        "–æ—Ç–¥—ã—Ö", "–æ—Ç–¥–æ—Ö–Ω—É–ª–∞", "–æ—Ç–¥–æ—Ö–Ω—É–ª", "–æ—Ç–¥–æ—Ö–Ω—É–ª–∏",
        "–≤—ã—Ö–æ–¥–Ω–æ–π", "–≤—ã—Ö–æ–¥–Ω—ã–µ", "–∫–∞–Ω–∏–∫—É–ª—ã", "–æ—Ç–ø—É—Å–∫",
        "–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª–∞", "–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª", "–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª–∞ –≤–µ—Å—å –¥–µ–Ω—å",
        "–ø–æ–ª–µ–∂–∞—Ç—å", "–ª–µ–∂–∞–ª–∞", "–ª–µ–∂–∞–ª", "–ª–µ–∂–∏–º",
        "–∫—Ä–æ–≤–∞—Ç—å", "–¥–∏–≤–∞–Ω", "–ø–æ–¥ –ø–ª–µ–¥–æ–º", "–ø–ª–µ–¥",
        "—Å–æ–Ω", "–ø–æ—Å–ø–∞–ª–∞", "–ø–æ—Å–ø–∞–ª", "–≤—ã—Å–ø–∞–ª–∞—Å—å", "–≤—ã—Å–ø–∞–ª—Å—è",
        "—Å–ø–æ–∫–æ–π–Ω—ã–π –≤–µ—á–µ—Ä", "—Ç–∏—Ö–∏–π –≤–µ—á–µ—Ä", "–≤–µ—á–µ—Ä –¥–ª—è —Å–µ–±—è",
        "—Å–µ—Ä–∏–∞–ª", "—Å–µ—Ä–∏–∞–ª—ã", "—Ñ–∏–ª—å–º", "–∫–∏–Ω–æ",
        "–∫–Ω–∏–≥–∞", "–∫–Ω–∏–≥–∏", "–ø–æ—á–∏—Ç–∞–ª–∞", "–ø–æ—á–∏—Ç–∞–ª",
        "–≤–∞–Ω–Ω–∞", "–≥–æ—Ä—è—á–∞—è –≤–∞–Ω–Ω–∞", "–¥—É—à", "—Å–ø–∞",
        "–º–∞—Å—Å–∞–∂",
    ],
    "—É—Å–ø–µ—Ö–∏": [
        "–ø–æ–ª—É—á–∏–ª–æ—Å—å", "–ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å", "–Ω–∞–∫–æ–Ω–µ—Ü –ø–æ–ª—É—á–∏–ª–æ—Å—å",
        "—É—Å–ø–µ—Ö", "—É—Å–ø–µ—Ö–∏", "—É–¥–∞–ª–æ—Å—å", "—É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å",
        "—Å–º–æ–≥–ª–∞", "—Å–º–æ–≥", "—Å–ø—Ä–∞–≤–∏–ª–∞—Å—å", "—Å–ø—Ä–∞–≤–∏–ª—Å—è",
        "–¥–æ–¥–µ–ª–∞–ª–∞", "–¥–æ–¥–µ–ª–∞–ª", "–∑–∞–∫–æ–Ω—á–∏–ª–∞", "–∑–∞–∫–æ–Ω—á–∏–ª–∞ –¥–µ–ª–æ",
        "—Å–¥–µ–ª–∞–ª–∞", "—Å–¥–µ–ª–∞–ª", "–∑–∞–≤–µ—Ä—à–∏–ª–∞", "–∑–∞–≤–µ—Ä—à–∏–ª",
        "—Å–¥–∞–ª–∞", "—Å–¥–∞–ª", "—ç–∫–∑–∞–º–µ–Ω", "–∑–∞—á—ë—Ç", "–∑–∞—á–µ—Ç", "–ø—Ä–æ–µ–∫—Ç",
        "–ø–æ–ª—É—á–∏–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç", "–ø–æ–ª—É—á–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–Ω–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞", "–Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫",
        "—Å–¥–µ–ª–∞–ª–∞ —à–∞–≥", "—Å–¥–µ–ª–∞–ª —à–∞–≥",
        "–ø—Ä–æ–≥—Ä–µ—Å—Å", "–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ", "–¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥", "–¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥",
        "–ø–æ–ª—É—á–∏–ª–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç", "–ø–æ–ª—É—á–∏–ª –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç",
        "–ø–æ–ª—É—á–∏–ª–∞ –ø–æ—Ö–≤–∞–ª—É", "–ø–æ–ª—É—á–∏–ª –ø–æ—Ö–≤–∞–ª—É",
    ],
}

JOY_THEME_COMMENTS = {
    "–µ–¥–∞": [
        "–í–∏–∂—É, —á—Ç–æ –≤–∫—É—Å–Ω–∞—è –µ–¥–∞ ‚Äî –æ–¥–Ω–∞ –∏–∑ —Ç–≤–æ–∏—Ö –æ–ø–æ—Ä. –≠—Ç–æ –æ—á–µ–Ω—å —Ç—ë–ø–ª–∞—è —Ä–∞–¥–æ—Å—Ç—å.",
        "–ö–∞–∂–µ—Ç—Å—è, —Ö–æ—Ä–æ—à–∏–µ –Ω–∞–ø–∏—Ç–∫–∏ –∏ –µ–¥–∞ –∑–∞–º–µ—Ç–Ω–æ –ø–æ–¥–Ω–∏–º–∞—é—Ç —Ç–µ–±–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. –ò —ç—Ç–æ –∑–¥–æ—Ä–æ–≤–æ.",
        "–ù–µ–º–Ω–æ–≥–æ –≤–∫—É—Å–Ω–æ–≥–æ ‚Äî –∏ –¥–µ–Ω—å —É–∂–µ –æ—â—É—â–∞–µ—Ç—Å—è –º—è–≥—á–µ. –ö–ª–∞—Å—Å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–µ–±—è –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å.",
    ],
    "–ª—é–¥–∏": [
        "–Ø –∑–∞–º–µ—á–∞—é, –∫–∞–∫ –º–Ω–æ–≥–æ —Ç–µ–ø–ª–∞ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –æ—Ç –ª—é–¥–µ–π —Ä—è–¥–æ–º. –≠—Ç–æ –ø—Ä–∞–≤–¥–∞ —Ü–µ–Ω–Ω–æ.",
        "–ü–æ—Ö–æ–∂–µ, –≤—Å—Ç—Ä–µ—á–∏ –∏ –æ–±—â–µ–Ω–∏–µ —Å–∏–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç–µ–±—è. –≠—Ç–æ –±–æ–ª—å—à–∞—è –æ–ø–æ—Ä–∞.",
        "–õ—é–¥–∏ –≤–æ–∫—Ä—É–≥ —Ç–µ–±—è ‚Äî –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å —Ç–≤–æ–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π. –¢—ã –Ω–µ –æ–¥–Ω–∞.",
    ],
    "–ø—Ä–∏—Ä–æ–¥–∞": [
        "–ö–∞–∂–µ—Ç—Å—è, –ø—Ä–∏—Ä–æ–¥–∞ –∏ –ø–æ–≥–æ–¥–∞ —Å–∏–ª—å–Ω–æ –≤–ª–∏—è—é—Ç –Ω–∞ —Ç–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –≠—Ç–æ –æ—á–µ–Ω—å –∂–∏–≤–∞—è –æ–ø–æ—Ä–∞.",
        "–°–æ–ª–Ω—Ü–µ, –≤–æ–∑–¥—É—Ö, –ø—Ä–æ–≥—É–ª–∫–∏ ‚Äî –ø–æ—Ö–æ–∂–µ, —ç—Ç–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø–æ–¥–ø–∏—Ç—ã–≤–∞–µ—Ç —Ç–≤–æ–π —Ä–µ—Å—É—Ä—Å.",
        "–£ —Ç–µ–±—è —á—É—Ç–∫–æ—Å—Ç—å –∫ –ø—Ä–∏—Ä–æ–¥–µ. –≠—Ç–æ –∫–ª–∞—Å—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–º–µ–¥–ª—è—Ç—å—Å—è –∏ –æ—Ç–¥—ã—Ö–∞—Ç—å.",
    ],
    "–æ—Ç–¥—ã—Ö": [
        "–Ø –≤–∏–∂—É, —á—Ç–æ –æ—Ç–¥—ã—Ö –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–¥–æ—Ö–Ω—É—Ç—å –≤–∞–∂–Ω—ã –¥–ª—è —Ç–µ–±—è. –≠—Ç–æ –Ω–µ –ª–µ–Ω—å, –∞ –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ.",
        "–¢–≤–æ—ë —Ç–µ–ª–æ —è–≤–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ –∑–∞ –º–æ–º–µ–Ω—Ç—ã, –∫–æ–≥–¥–∞ —Ç—ã –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–∞.",
        "–ö–æ–≥–¥–∞ —Ç—ã –≤—ã–±–∏—Ä–∞–µ—à—å –æ—Ç–¥—ã—Ö ‚Äî —Ç—ã –≤—ã–±–∏—Ä–∞–µ—à—å —Å–µ–±—è. –≠—Ç–æ –≤–∞–∂–Ω–æ.",
    ],
    "—É—Å–ø–µ—Ö–∏": [
        "–¢—ã —á–∞—Å—Ç–æ –æ—Ç–º–µ—á–∞–µ—à—å —Å–≤–æ–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã. –≠—Ç–æ –æ—á–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∞—è –ø—Ä–∏–≤—ã—á–∫–∞.",
        "–ö–∞–∂–µ—Ç—Å—è, —Ç–µ–±–µ –≤–∞–∂–Ω–æ –∑–∞–º–µ—á–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å. –ò —Ç—ã –ø—Ä–∞–≤–¥–∞ –º–Ω–æ–≥–æ –≤—Å–µ–≥–æ –¥–µ–ª–∞–µ—à—å.",
        "–£ —Ç–µ–±—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥, —à–∞–≥ –∑–∞ —à–∞–≥–æ–º. –≠—Ç–æ —Å—Ç–æ–∏—Ç —É–≤–∞–∂–µ–Ω–∏—è.",
    ],
}

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ä–∞–¥–æ—Å—Ç–∏
JOY_RESPONSES = [
    "–ó–∞–ø–∏—Å–∞–ª–∞ —ç—Ç–æ –∫–∞–∫ —Ç–≤–æ—é —Ä–∞–¥–æ—Å—Ç—å –¥–Ω—è.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞. –¢–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Ç–æ—á–Ω–æ —Å—Ç–æ–∏—Ç –ø–æ–º–Ω–∏—Ç—å.",
    "–î–æ–±–∞–≤–∏–ª–∞ –≤ —Ç–≤–æ–π –¥–Ω–µ–≤–Ω–∏–∫ —Ö–æ—Ä–æ—à–µ–≥–æ.",
    "–û—Ç–º–µ—Ç–∏–ª–∞ —ç—Ç—É —Ä–∞–¥–æ—Å—Ç—å. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∞—Å—å.",
    "–ó–∞–ø–∏—Å–∞–ª–∞. –ü—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç —Ç–≤–æ–µ–π –º–∞–ª–µ–Ω—å–∫–æ–π –æ–ø–æ—Ä–æ–π.",
    "–ü–æ–ª–æ–∂–∏–ª–∞ —ç—Ç—É —Ä–∞–¥–æ—Å—Ç—å –≤ —Ç–≤–æ—é –∫–æ–ø–∏–ª–∫—É.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç ‚Äî –æ–Ω –≤–∞–∂–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è.",
    "–û—Ç–º–µ—Ç–∏–ª–∞ —ç—Ç–æ –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–∏–π —à—Ç—Ä–∏—Ö –∫ —Ç–≤–æ–µ–º—É –¥–Ω—é.",
    "–ó–∞–±—Ä–∞–ª–∞ —ç—Ç—É —Ä–∞–¥–æ—Å—Ç—å –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ. –û–Ω–∞ —Ç–µ–ø–µ—Ä—å —Å —Ç–æ–±–æ–π.",
    "–ó–∞–ø–∏—Å–∞–ª–∞. –í –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∫ –Ω–µ–π –≤–µ—Ä–Ω—É—Ç—å—Å—è.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ ‚Äî –ø—É—Å—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç, —á—Ç–æ –Ω–µ –≤—Å—ë –≤ —ç—Ç–æ–º –¥–Ω–µ –±—ã–ª–æ —Ç—è–∂—ë–ª—ã–º.",
    "–î–æ–±–∞–≤–∏–ª–∞ –≤ —Å–ø–∏—Å–æ–∫ —Ö–æ—Ä–æ—à–∏—Ö –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Å —Ç–æ–±–æ–π —Å–ª—É—á–∞–ª–∏—Å—å.",
    "–ó–∞–ø–∏—Å–∞–ª–∞ –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–∏–π, –Ω–æ —Ü–µ–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.",
    "–û—Ç–º–µ—Ç–∏–ª–∞. –¢–∞–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Å–∏–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∏–∑–Ω—É—Ç—Ä–∏.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞. –¢—ã –º–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –∑–∞–º–µ—á–∞–µ—à—å —Ç–∞–∫–∏–µ –≤–µ—â–∏.",
    "–ó–∞–ø–∏—Å–∞–ª–∞. –≠—Ç–æ –∑–≤—É—á–∏—Ç —Ç—ë–ø–ª–æ.",
    "–ü–æ–ª–æ–∂–∏–ª–∞ –≤ —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∞—Ä—Ö–∏–≤ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–∞–¥–æ—Å—Ç–µ–π.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –∫–∞–∂–µ—Ç—Å—è –º–µ–ª–æ—á—å—é, –æ–Ω–∞ –≤–∞–∂–Ω–∞.",
    "–î–æ–±–∞–≤–∏–ª–∞ —ç—Ç–æ –≤ —Ç–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é —Ö–æ—Ä–æ—à–∏—Ö –¥–Ω–µ–π.",
    "–ó–∞–ø–∏—Å–∞–ª–∞. –ü—É—Å—Ç—å –Ω–∞–ø–æ–º–Ω–∏—Ç —Ç–µ–±–µ, —á—Ç–æ —Ç—ã —É–º–µ–µ—à—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —É—é—Ç –≤–æ–∫—Ä—É–≥.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ —ç—Ç–æ—Ç —ç–ø–∏–∑–æ–¥, –æ–Ω —Ç–æ—á–Ω–æ –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –º–µ—Å—Ç–∞ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ.",
    "–ó–∞–ø–∏—Å–∞–ª–∞ ‚Äî –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è, –∫–∞–∫ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å —Ç–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã.",
    "–û—Ç–º–µ—Ç–∏–ª–∞ —ç—Ç—É –¥–µ—Ç–∞–ª—å. –í —Å—É–º–º–µ –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç –æ—â—É—â–µ–Ω–∏–µ –∂–∏–∑–Ω–∏.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞. –ò–Ω–æ–≥–¥–∞ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–µ –∏ —Å–ø–∞—Å–∞–µ—Ç –¥–µ–Ω—å.",
    "–ó–∞–ø–∏—Å–∞–ª–∞. –≠—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∫ —Å–µ–±–µ.",
    "–î–æ–±–∞–≤–∏–ª–∞ –≤ —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç–≤–æ–π –¥–µ–Ω—å –º—è–≥—á–µ.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞. –¢—ã –ø—Ä–∞–≤–¥–∞ —É–º–µ–µ—à—å –≤–∏–¥–µ—Ç—å —Å–≤–µ—Ç–ª–æ–µ.",
    "–ó–∞–ø–∏—Å–∞–ª–∞. –í —Ç—è–∂—ë–ª—ã–µ –¥–Ω–∏ —Ç–∞–∫–∏–µ –∑–∞–ø–∏—Å–∏ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç.",
    "–û—Ç–º–µ—Ç–∏–ª–∞. –≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π —à—Ç—Ä–∏—Ö –∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º—É –¥–Ω—é.",
    "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç ‚Äî –æ–Ω –º–æ–∂–µ—Ç –ø—Ä–∏–≥–æ–¥–∏—Ç—å—Å—è, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—Ç—Å—è —Ç–µ–ø–ª–∞.",
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ –≥—Ä—É—Å—Ç—å
SAD_RESPONSES = [
    "–ó–≤—É—á–∏—Ç –∫–∞–∫ –Ω–µ–ø—Ä–æ—Å—Ç–æ–π –¥–µ–Ω—å. –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã—Ç–∞—Å–∫–∏–≤–∞—Ç—å –∏–∑ –Ω–µ–≥–æ —Ä–∞–¥–æ—Å—Ç—å —Å–∏–ª–æ–π.\n\n"
    "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, –ø–æ–ø—Ä–æ–±—É–π –≤—Å–ø–æ–º–Ω–∏—Ç—å –æ–¥–∏–Ω –º–æ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —á—É—Ç—å –º—è–≥—á–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.",
    "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –º–æ–≥–ª–æ –±—ã—Ç—å —Ç—è–∂–µ–ª–æ.\n\n"
    "–ú–æ–∂–Ω–æ –Ω–µ –∏—Å–∫–∞—Ç—å —á–µ–≥–æ-—Ç–æ –±–æ–ª—å—à–æ–≥–æ. –ò–Ω–æ–≥–¥–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç—ë–ø–ª–æ–≥–æ —á–∞—è –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–æ–≥–æ-—Ç–æ –±–ª–∏–∑–∫–æ–≥–æ.",
    "–ë—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–µ–Ω—å —Å–æ–≤—Å–µ–º –Ω–µ —Ä–∞–¥—É–µ—Ç. –¢–∞–∫ —Ç–æ–∂–µ –º–æ–∂–Ω–æ.\n\n"
    "–ï—Å–ª–∏ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∑–∞—Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å –æ—Ç–º–µ—Ç–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –Ω–µ–±–æ–ª—å—à—É—é –æ–ø–æ—Ä—É ‚Äî —è –µ—ë —Å–æ—Ö—Ä–∞–Ω—é.",
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —É—Å—Ç–∞–ª–æ—Å—Ç—å
TIRED_RESPONSES = [
    "–ü–æ—Ö–æ–∂–µ, —Å–µ–≥–æ–¥–Ω—è –±—ã–ª–æ –Ω–µ–ø—Ä–æ—Å—Ç–æ, –∏ —Ç—ã —Å–∏–ª—å–Ω–æ —É—Å—Ç–∞–ª–∞.\n\n"
    "–≠—Ç–æ –Ω–µ –ø—Ä–æ —Å–ª–∞–±–æ—Å—Ç—å, –∞ –ø—Ä–æ —Ç–æ, —á—Ç–æ —Ç—ã –º–Ω–æ–≥–æ –Ω–∞ —Å–µ–±–µ –Ω–µ—Å—ë—à—å.",
    "–°–ª—ã—à—É —É—Å—Ç–∞–ª–æ—Å—Ç—å. –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –±—ã—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.\n\n"
    "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, –Ω–∞–ø–∏—à–∏, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è –¥–∞–ª–æ —Ç–µ–±–µ —Ö–æ—Ç—å –º–∞–ª–µ–Ω—å–∫—É—é –ø–µ—Ä–µ–¥—ã—à–∫—É.",
    "–≠–Ω–µ—Ä–≥–∏–∏ —Å–µ–≥–æ–¥–Ω—è —è–≤–Ω–æ –±—ã–ª–æ –º–∞–ª–æ.\n\n"
    "–ò–Ω–æ–≥–¥–∞ —Ä–∞–¥–æ—Å—Ç—å ‚Äî —ç—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç —Ç–∏—à–∏–Ω—ã –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ –ª–µ—á—å –∏ –≤—ã–¥–æ—Ö–Ω—É—Ç—å.",
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ç—Ä–µ–≤–æ–≥—É
ANXIETY_RESPONSES = [
    "–ß—É–≤—Å—Ç–≤—É–µ—Ç—Å—è —Ç—Ä–µ–≤–æ–≥–∞. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –¥–ª—è —Ç–µ–±—è –º–Ω–æ–≥–æ–µ –≤–∞–∂–Ω–æ.\n\n"
    "–ü–æ–ø—Ä–æ–±—É–π –≤—Å–ø–æ–º–Ω–∏—Ç—å –æ–¥–Ω—É –≤–µ—â—å, —Å –∫–æ—Ç–æ—Ä–æ–π —Ç—ã –≤—Å—ë-—Ç–∞–∫–∏ —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å —Å–µ–≥–æ–¥–Ω—è.",
    "–°–ª—ã—à—É, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—Å–ø–æ–∫–æ–π–Ω–æ.\n\n"
    "–ò–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –∑–∞—Ü–µ–ø–∏—Ç—å—Å—è –∑–∞ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Ç—Ä–µ–≤–æ–≥–∞ –±—ã–ª–∞ —á—É—Ç—å —Ç–∏—à–µ ‚Äî –º—É–∑—ã–∫–∞, —Ä–∞–∑–≥–æ–≤–æ—Ä, —á–∞–π.",
    "–¢—Ä–µ–≤–æ–≥–∞ —É–º–µ–µ—Ç –Ω–∞–∫—Ä—É—á–∏–≤–∞—Ç—å. –ù–æ —Ç—ã —É–∂–µ —Å–ø—Ä–∞–≤–ª—è–ª–∞—Å—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏ —Ä–∞–Ω—å—à–µ.\n\n"
    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –æ –º–æ–º–µ–Ω—Ç–µ, –≥–¥–µ —Ç—ã –≤—Å—ë-—Ç–∞–∫–∏ –≤—ã–¥–µ—Ä–∂–∞–ª–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.",
]

# –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª)
REMINDER_TEXTS = [
    "–ö–∞–∂–µ—Ç—Å—è, –¥–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É. –ï—Å–ª–∏ –±—ã–ª–æ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–∏—è—Ç–Ω–æ–µ ‚Äî –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –º–Ω–µ –æ–± —ç—Ç–æ–º.",
    "–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–ø—Ä–æ—Å—Ç–æ. –ù–æ, –º–æ–∂–µ—Ç –±—ã—Ç—å, –Ω–∞–π–¥—ë—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–æ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—á–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å?",
    "–ï—Å–ª–∏ –≤ —ç—Ç–æ–º –¥–Ω–µ –±—ã–ª–æ —á—Ç–æ-—Ç–æ –Ω–µ —Å–æ–≤—Å–µ–º —É–∂–∞—Å–Ω–æ–µ ‚Äî –º–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å —ç—Ç–æ –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫—É—é —Ä–∞–¥–æ—Å—Ç—å.",
    "–ò–Ω–æ–≥–¥–∞ –¥–∞–∂–µ —á–∞—à–∫–∞ —á–∞—è –∏–ª–∏ —Å–ø–æ–∫–æ–π–Ω—ã–π –≤–µ—á–µ—Ä ‚Äî —É–∂–µ –ø–æ–≤–æ–¥ –¥–ª—è –∑–∞–ø–∏—Å–∏. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –Ω–∞–ø–∏—à–∏ –æ–± —ç—Ç–æ–º.",
    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å –æ–¥–Ω—É –Ω–µ–±–æ–ª—å—à—É—é –≤–µ—â—å, –∫–æ—Ç–æ—Ä–∞—è —Å–¥–µ–ª–∞–ª–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å —Ç–µ—Ä–ø–∏–º–µ–µ.",
    "–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —á—Ç–æ-—Ç–æ –±–æ–ª—å—à–æ–µ. –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≤—Å–µ–º –º–∞–ª–µ–Ω—å–∫—É—é –¥–µ—Ç–∞–ª—å, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–≥—Ä–µ–ª–∞ —Ç–µ–±—è.",
    "–ï—Å–ª–∏ –≤—Å–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —á—Ç–æ-—Ç–æ —Ç—ë–ø–ª–æ–µ, –¥–∞–∂–µ –Ω–∞ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ ‚Äî —è –≥–æ—Ç–æ–≤–∞ —ç—Ç–æ –∑–∞–ø–∏—Å–∞—Ç—å.",
    "–î–∞–∂–µ –≤ —Å–ª–æ–∂–Ω—ã–π –¥–µ–Ω—å –æ–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–∞–ª–µ–Ω—å–∫–∏–π –æ—Å—Ç—Ä–æ–≤–æ–∫ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è. –ú–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –æ –Ω—ë–º.",
    "–ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —Ç–µ–±–µ –∫—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞–ª, –ø–æ–¥–¥–µ—Ä–∂–∞–ª, —É–ª—ã–±–Ω—É–ª—Å—è ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.",
    "–ú–æ–∂–µ—Ç –±—ã—Ç—å, —Ç—ã –ø—Ä–æ—Å—Ç–æ —Å–ø–æ–∫–æ–π–Ω–æ –¥–æ—à–ª–∞ –¥–æ —ç—Ç–æ–≥–æ –≤–µ—á–µ—Ä–∞. –≠—Ç–æ —Ç–æ–∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å.",
    "–ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –≤—Å—ë, —á—Ç–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ: –µ–¥–∞, –ª—é–¥–∏, –º—É–∑—ã–∫–∞, –ø–æ–≥–æ–¥–∞, —Ç–∏—à–∏–Ω–∞.",
    "–ï—Å–ª–∏ –¥–µ–Ω—å —Ç—è–∂—ë–ª—ã–π, —Ä–∞–¥–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–π. –ù–æ –æ–Ω–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è.",
    "–•–æ—á–µ—à—å, –º—ã –Ω–∞–π–¥—ë–º —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ –≤ —ç—Ç–æ–º –¥–Ω–µ –≤–º–µ—Å—Ç–µ? –ù–∞–ø–∏—à–∏ –ª—é–±—É—é –¥–µ—Ç–∞–ª—å, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –Ω–µ —Å–æ–≤—Å–µ–º –ø–ª–æ—Ö–æ–π.",
    "–ú–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å —Å—é–¥–∞ –¥–∞–∂–µ –æ–¥–Ω—É —Ñ—Ä–∞–∑—É ‚Äî –∏ —ç—Ç–æ–≥–æ —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è.",
    "–ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç —Å–∏–ª –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Ä–∞–¥–æ—Å—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –±—ã–ª–æ —á—É—Ç—å –ø–æ–ª–µ–≥—á–µ.",
    "–ù–µ –¥–∞–≤–∏ –Ω–∞ —Å–µ–±—è. –ï—Å–ª–∏ –≤—Å–ø–ª—ã–≤–∞–µ—Ç —Ö–æ—Ç—å –æ–¥–Ω–∞ —Ç—ë–ø–ª–∞—è –º–µ–ª–æ—á—å ‚Äî —è –µ—ë —Å–æ—Ö—Ä–∞–Ω—é.",
    "–ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å —Å–∞–º–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ: ¬´–Ø –¥–æ—à–ª–∞ –¥–æ —ç—Ç–æ–≥–æ –≤–µ—á–µ—Ä–∞¬ª. –≠—Ç–æ —É–∂–µ –Ω–µ–º–∞–ª–æ.",
    "–ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è, –Ω–∞–ø–∏—à–∏, –∑–∞ —á—Ç–æ —Ç—ã —Å–µ–≥–æ–¥–Ω—è –º–æ–∂–µ—à—å —Å–∫–∞–∑–∞—Ç—å —Å–µ–±–µ ¬´—Å–ø–∞—Å–∏–±–æ¬ª.",
    "–ò–Ω–æ–≥–¥–∞ —Ä–∞–¥–æ—Å—Ç—å ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –¥–µ–Ω—å –ø—Ä–æ—Å—Ç–æ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è. –ú–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –æ–± —ç—Ç–æ–º, –µ—Å–ª–∏ —Ç–∞–∫.",
    "–¢—ã –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ, –µ—Å–ª–∏ —ç—Ç–æ —Ö–æ—Ç—å –Ω–µ–º–Ω–æ–≥–æ —Å–æ–≥—Ä–µ–ª–æ —Ç–µ–±—è —Å–µ–≥–æ–¥–Ω—è.",
]

# –ü–æ—Ä–æ–≥–∏ –¥–ª—è —Ä–∏—Ç—É–∞–ª–∞ ¬´3 –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∞–¥–æ—Å—Ç–∏¬ª
SAD_RITUAL_DAYS = 3
SAD_RITUAL_THRESHOLD = 3

# –ü—Ä–æ—Ñ–∞–Ω–∏—Ç–∏-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
PROFANITY_HINT_THRESHOLDS = (3, 10, 20)
PROFANITY_HINT_MESSAGES = [
    "–î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –æ–±—Ö–æ–¥–∏—Ç—å—Å—è –±–µ–∑ –º–∞—Ç–∞ ‚Äî —è –∏ —Ç–∞–∫ —Ç–µ–±—è –ø–æ–Ω–∏–º–∞—é.",
    "–ö–∞–∂–µ—Ç—Å—è, –≤ —Ä–µ—á–∏ –º–Ω–æ–≥–æ –º–∞—Ç–∞. –ï—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π –∑–∞–º–µ–Ω–∏—Ç—å –µ–≥–æ –Ω–∞ –æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞.",
    "–ú–æ–≥—É —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–≤–æ–∏ –º—ã—Å–ª–∏ –∏ –±–µ–∑ –∫—Ä–µ–ø–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π ‚Äî —Ç–∞–∫ —Ç–µ–∫—Å—Ç –ø–æ—Ç–æ–º –±—É–¥–µ—Ç –ø—Ä–∏—è—Ç–Ω–µ–µ –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞—Ç—å.",
]


# --------------------------
# Telegram API
# --------------------------

def get_updates(offset: Optional[int] = None, timeout: int = POLL_TIMEOUT) -> List[dict]:
    params = {"timeout": timeout}
    if offset is not None:
        params["offset"] = offset
    try:
        resp = requests.get(f"{API_URL}/getUpdates", params=params, timeout=timeout + 5)
        data = resp.json()
        if not data.get("ok"):
            print("getUpdates error:", data)
            return []
        return data.get("result", [])
    except Exception as e:
        print("getUpdates exception:", e)
        return []


def send_message(chat_id: int, text: str):
    try:
        requests.post(
            f"{API_URL}/sendMessage",
            json={"chat_id": chat_id, "text": text},
            timeout=10,
        )
    except Exception as e:
        print("sendMessage error:", e)


# --------------------------
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
# --------------------------

def init_db():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS joys (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            text TEXT NOT NULL,
            created_at TEXT NOT NULL
        )
        """
    )

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS sad_events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            created_at TEXT NOT NULL
        )
        """
    )

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS message_emotions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            emotion TEXT NOT NULL,
            source_text TEXT NOT NULL,
            created_at TEXT NOT NULL
        )
        """
    )

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS joy_keywords (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            keyword TEXT NOT NULL,
            created_at TEXT NOT NULL
        )
        """
    )

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS profanity_stats (
            chat_id INTEGER PRIMARY KEY,
            count INTEGER NOT NULL DEFAULT 0
        )
        """
    )

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS letters (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER NOT NULL,
            text TEXT NOT NULL,
            created_at TEXT NOT NULL,
            deliver_at TEXT NOT NULL,
            sent INTEGER NOT NULL DEFAULT 0
        )
        """
    )

    conn.commit()
    conn.close()


def add_joy(chat_id: int, text: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    created_at = datetime.now().isoformat(timespec="seconds")
    cur.execute(
        "INSERT INTO joys (chat_id, text, created_at) VALUES (?, ?, ?)",
        (chat_id, text, created_at),
    )
    conn.commit()
    conn.close()


def add_sad_event(chat_id: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    created_at = datetime.now().isoformat(timespec="seconds")
    cur.execute(
        "INSERT INTO sad_events (chat_id, created_at) VALUES (?, ?)",
        (chat_id, created_at),
    )
    conn.commit()
    conn.close()


def add_message_emotion(chat_id: int, emotion: str, source_text: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    created_at = datetime.now().isoformat(timespec="seconds")
    cur.execute(
        "INSERT INTO message_emotions (chat_id, emotion, source_text, created_at) "
        "VALUES (?, ?, ?, ?)",
        (chat_id, emotion, source_text, created_at),
    )
    conn.commit()
    conn.close()


def add_joy_keywords(chat_id: int, keywords: List[str]):
    if not keywords:
        return
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    created_at = datetime.now().isoformat(timespec="seconds")
    for kw in keywords:
        cur.execute(
            "INSERT INTO joy_keywords (chat_id, keyword, created_at) VALUES (?, ?, ?)",
            (chat_id, kw, created_at),
        )
    conn.commit()
    conn.close()


def add_letter(chat_id: int, text: str, days_ahead: int = 30):
    now = datetime.now()
    created_at = now.isoformat(timespec="seconds")
    deliver_at = (now + timedelta(days=days_ahead)).isoformat(timespec="seconds")

    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        INSERT INTO letters (chat_id, text, created_at, deliver_at, sent)
        VALUES (?, ?, ?, ?, 0)
        """,
        (chat_id, text, created_at, deliver_at),
    )
    conn.commit()
    conn.close()


def get_due_letters() -> List[tuple]:
    now_iso = datetime.now().isoformat(timespec="seconds")
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        SELECT id, chat_id, text
        FROM letters
        WHERE sent = 0
          AND deliver_at <= ?
        """,
        (now_iso,),
    )
    rows = cur.fetchall()
    conn.close()
    return rows


def mark_letter_sent(letter_id: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "UPDATE letters SET sent = 1 WHERE id = ?",
        (letter_id,),
    )
    conn.commit()
    conn.close()


def get_sad_count_last_days(chat_id: int, days: int) -> int:
    today_local = datetime.now().date()
    start = today_local - timedelta(days=days - 1)
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        SELECT COUNT(*)
        FROM sad_events
        WHERE chat_id = ?
          AND substr(created_at,1,10) >= ?
        """,
        (chat_id, start.isoformat()),
    )
    count = cur.fetchone()[0]
    conn.close()
    return count


def get_joys_for_date(chat_id: int, date_obj: date) -> List[Tuple[str, str]]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    date_str = date_obj.isoformat()
    cur.execute(
        """
        SELECT created_at, text
        FROM joys
        WHERE chat_id = ?
          AND substr(created_at,1,10) = ?
        ORDER BY created_at ASC
        """,
        (chat_id, date_str),
    )
    rows = cur.fetchall()
    conn.close()
    return rows


def has_joy_for_date(chat_id: int, date_obj: date) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    date_str = date_obj.isoformat()
    cur.execute(
        """
        SELECT COUNT(*)
        FROM joys
        WHERE chat_id = ?
          AND substr(created_at, 1, 10) = ?
        """,
        (chat_id, date_str),
    )
    count = cur.fetchone()[0]
    conn.close()
    return count > 0


def get_all_user_ids() -> List[int]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT DISTINCT chat_id FROM joys")
    rows = cur.fetchall()
    conn.close()
    return [r[0] for r in rows]


def get_joy_count(chat_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT COUNT(*) FROM joys WHERE chat_id = ?",
        (chat_id,),
    )
    count = cur.fetchone()[0]
    conn.close()
    return count


def get_distinct_joy_dates(chat_id: int) -> List[date]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        SELECT DISTINCT substr(created_at, 1, 10) as d
        FROM joys
        WHERE chat_id = ?
        ORDER BY d ASC
        """,
        (chat_id,),
    )
    rows = cur.fetchall()
    conn.close()
    dates = []
    for (d_str,) in rows:
        try:
            dates.append(date.fromisoformat(d_str))
        except Exception:
            pass
    return dates


def get_first_joy_date(chat_id: int) -> Optional[date]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        SELECT MIN(substr(created_at, 1, 10))
        FROM joys
        WHERE chat_id = ?
        """,
        (chat_id,),
    )
    row = cur.fetchone()
    conn.close()
    if row and row[0]:
        try:
            return date.fromisoformat(row[0])
        except Exception:
            return None
    return None


def get_joys_last_n_days(chat_id: int, days: int = 7) -> int:
    today_local = datetime.now().date()
    start = today_local - timedelta(days=days - 1)
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        SELECT COUNT(*)
        FROM joys
        WHERE chat_id = ?
          AND substr(created_at,1,10) >= ?
        """,
        (chat_id, start.isoformat()),
    )
    count = cur.fetchone()[0]
    conn.close()
    return count


def get_joys_for_last_days(chat_id: int, days: int = 30) -> List[Tuple[str, str]]:
    today_local = datetime.now().date()
    start = today_local - timedelta(days=days - 1)
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        SELECT created_at, text
        FROM joys
        WHERE chat_id = ?
          AND substr(created_at,1,10) >= ?
        ORDER BY created_at ASC
        """,
        (chat_id, start.isoformat()),
    )
    rows = cur.fetchall()
    conn.close()
    return rows


def get_current_streak(chat_id: int) -> int:
    dates = get_distinct_joy_dates(chat_id)
    if not dates:
        return 0

    today_local = datetime.now().date()
    last_date = dates[-1]
    if last_date < today_local - timedelta(days=1):
        return 0

    streak = 1
    i = len(dates) - 1
    while i > 0:
        if (dates[i] - dates[i - 1]).days == 1:
            streak += 1
            i -= 1
        else:
            break
    return streak


def get_top_keywords(chat_id: int, days: Optional[int] = None, limit: int = 3) -> List[str]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    if days is None:
        cur.execute(
            """
            SELECT keyword, COUNT(*) as c
            FROM joy_keywords
            WHERE chat_id = ?
            GROUP BY keyword
            ORDER BY c DESC
            LIMIT ?
            """,
            (chat_id, limit),
        )
    else:
        today_local = datetime.now().date()
        start = today_local - timedelta(days=days - 1)
        cur.execute(
            """
            SELECT keyword, COUNT(*) as c
            FROM joy_keywords
            WHERE chat_id = ?
              AND substr(created_at,1,10) >= ?
            GROUP BY keyword
            ORDER BY c DESC
            LIMIT ?
            """,
            (chat_id, start.isoformat(), limit),
        )

    rows = cur.fetchall()
    conn.close()
    return [r[0] for r in rows]


def get_emotion_stats_last_days(chat_id: int, days: int = 7) -> Dict[str, int]:
    today_local = datetime.now().date()
    start = today_local - timedelta(days=days - 1)
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        """
        SELECT emotion, COUNT(*)
        FROM message_emotions
        WHERE chat_id = ?
          AND substr(created_at,1,10) >= ?
        GROUP BY emotion
        """,
        (chat_id, start.isoformat()),
    )
    rows = cur.fetchall()
    conn.close()
    return {emotion: count for emotion, count in rows}


# profanity stats

def increment_profanity(chat_id: int, delta: int = 1) -> int:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT count FROM profanity_stats WHERE chat_id = ?",
        (chat_id,),
    )
    row = cur.fetchone()

    if row is None:
        new_count = delta
        cur.execute(
            "INSERT INTO profanity_stats (chat_id, count) VALUES (?, ?)",
            (chat_id, new_count),
        )
    else:
        new_count = row[0] + delta
        cur.execute(
            "UPDATE profanity_stats SET count = ? WHERE chat_id = ?",
            (new_count, chat_id),
        )

    conn.commit()
    conn.close()
    return new_count


def get_profanity_count(chat_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT count FROM profanity_stats WHERE chat_id = ?",
        (chat_id,),
    )
    row = cur.fetchone()
    conn.close()
    return row[0] if row else 0


# --------------------------
# –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
# --------------------------

def clean_profanity(text: str) -> str:
    lower = text.lower()
    for bad in BAD_WORDS:
        if bad in lower:
            replacement = "*" * len(bad)
            res_chars = []
            i = 0
            while i < len(text):
                segment = text[i:i + len(bad)]
                if segment.lower() == bad:
                    res_chars.append(replacement)
                    i += len(bad)
                else:
                    res_chars.append(text[i])
                    i += 1
            text = "".join(res_chars)
            lower = text.lower()
    return text


def fix_spelling_with_languagetool(text: str) -> str:
    if not USE_LANGTOOL:
        return text
    try:
        resp = requests.post(
            LANGTOOL_URL,
            data={"text": text, "language": "ru"},
            timeout=10,
        )
        data = resp.json()
        matches = data.get("matches", [])
        if not matches:
            return text
        text_chars = list(text)
        for m in reversed(matches):
            repls = m.get("replacements")
            if not repls:
                continue
            best = repls[0].get("value")
            offset = m.get("offset", 0)
            length = m.get("length", 0)
            text_chars[offset: offset + length] = list(best)
        return "".join(text_chars)
    except Exception as e:
        print("LanguageTool error:", e)
        return text


def clean_text_pipeline(text: str) -> str:
    text = text.strip()
    if not text:
        return text
    text = clean_profanity(text)
    text = fix_spelling_with_languagetool(text)
    return text


# --------------------------
# –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ —Ç–µ–º
# --------------------------

def is_severe_sad_message(text: str) -> bool:
    lower = text.lower()
    return any(p in lower for p in SEVERE_SAD_PATTERNS)


def is_sad_message(text: str) -> bool:
    lower = text.lower()
    return any(p in lower for p in SAD_PATTERNS)


def is_tired_message(text: str) -> bool:
    lower = text.lower()
    return any(p in lower for p in TIRED_PATTERNS)


def is_anxiety_message(text: str) -> bool:
    lower = text.lower()
    return any(p in lower for p in ANXIETY_PATTERNS)


def is_greeting_message(text: str) -> bool:
    lower = text.lower().strip()
    return any(lower == p for p in GREETING_PATTERNS)


def analyze_emotion(text: str) -> str:
    """
    –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ —ç–º–æ—Ü–∏–π.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 'severe_sad', 'sad', 'tired', 'anxiety', 'joy', 'other'.
    """
    if is_severe_sad_message(text):
        return "severe_sad"
    if is_anxiety_message(text):
        return "anxiety"
    if is_tired_message(text):
        return "tired"
    if is_sad_message(text):
        return "sad"
    if not text.startswith("/") and not is_greeting_message(text):
        return "joy"
    return "other"


def extract_keywords(text: str, max_kw: int = 5) -> List[str]:
    cleaned = ""
    for ch in text.lower():
        if ch.isalpha() or ch.isdigit() or ch == " ":
            cleaned += ch
        else:
            cleaned += " "
    words = [w for w in cleaned.split() if len(w) > 2 and w not in STOPWORDS]
    seen = set()
    result = []
    for w in words:
        if w not in seen:
            seen.add(w)
            result.append(w)
        if len(result) >= max_kw:
            break
    return result


def detect_joy_themes(text: str) -> List[str]:
    lower = text.lower()
    found = []
    for theme, words in JOY_THEMES.items():
        for w in words:
            if w in lower:
                found.append(theme)
                break
    return found


def get_theme_stats_last_days(chat_id: int, days: int = 7) -> Dict[str, int]:
    joys = get_joys_for_last_days(chat_id, days)
    stats: Dict[str, int] = {}
    for _, text in joys:
        themes = detect_joy_themes(text)
        for t in themes:
            stats[t] = stats.get(t, 0) + 1
    return stats


# --------------------------
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
# --------------------------

def add_emoji_prefix(text: str) -> str:
    return f"{random.choice(CALM_EMOJIS)} {text}"


def get_sad_response() -> str:
    return add_emoji_prefix(random.choice(SAD_RESPONSES))


def get_tired_response() -> str:
    return add_emoji_prefix(random.choice(TIRED_RESPONSES))


def get_anxiety_response() -> str:
    return add_emoji_prefix(random.choice(ANXIETY_RESPONSES))


def get_greeting_response() -> str:
    return add_emoji_prefix(random.choice(GREETING_RESPONSES))


def get_joy_response() -> str:
    return add_emoji_prefix(random.choice(JOY_RESPONSES))


def handle_profanity(chat_id: int):
    new_count = increment_profanity(chat_id)
    if new_count in PROFANITY_HINT_THRESHOLDS:
        msg = random.choice(PROFANITY_HINT_MESSAGES)
        send_message(chat_id, add_emoji_prefix(msg))


# --------------------------
# –ê—á–∏–≤–∫–∏
# --------------------------

def check_and_send_achievements(chat_id: int):
    total = get_joy_count(chat_id)
    streak = get_current_streak(chat_id)

    messages = []

    if total == 1:
        options = [
            "–ü–µ—Ä–≤–∞—è —Ä–∞–¥–æ—Å—Ç—å –∑–∞–ø–∏—Å–∞–Ω–∞. –•–æ—Ä–æ—à–µ–µ –Ω–∞—á–∞–ª–æ.",
            "–¢—ã —Å–¥–µ–ª–∞–ª–∞ –ø–µ—Ä–≤—ã–π —à–∞–≥. –î–∞–ª—å—à–µ –±—É–¥–µ—Ç –ø—Ä–æ—â–µ –∑–∞–º–µ—á–∞—Ç—å –ø—Ä–∏—è—Ç–Ω–æ–µ.",
            "–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –µ—Å—Ç—å. –ú–æ–∂–Ω–æ –ø–æ—Ç–∏—Ö–æ–Ω—å–∫—É –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å.",
        ]
        messages.append(add_emoji_prefix(random.choice(options)))
    elif total == 7:
        options = [
            "–°–µ–º—å –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π ‚Äî —É–∂–µ —Ü–µ–ª–∞—è –Ω–µ–¥–µ–ª—è.",
            "–ù–µ–¥–µ–ª—è —Å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º–∏ —Ä–∞–¥–æ—Å—Ç—è–º–∏. –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∏–≤—ã—á–∫–∞.",
            "–£ —Ç–µ–±—è —É–∂–µ —Å–µ–º—å —Ä–∞–¥–æ—Å—Ç–µ–π –≤ –∫–æ–ø–∏–ª–∫–µ. –ó–≤—É—á–∏—Ç –∑–¥–æ—Ä–æ–≤–æ.",
        ]
        messages.append(add_emoji_prefix(random.choice(options)))
    elif total == 30:
        options = [
            "–¢—Ä–∏–¥—Ü–∞—Ç—å —Ä–∞–¥–æ—Å—Ç–µ–π ‚Äî —Å–æ–ª–∏–¥–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è.",
            "30 –∑–∞–ø–∏—Å–µ–π ‚Äî —ç—Ç–æ —É–∂–µ –∑–∞–º–µ—Ç–Ω—ã–π —Å–ª–µ–¥ –≤ —Ç–≤–æ—ë–º –µ–∂–µ–¥–Ω–µ–≤–∏–∏.",
            "–£ —Ç–µ–±—è 30 –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏—è—Ç–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤. –≠—Ç–æ –≤–∞–∂–Ω–æ.",
        ]
        messages.append(add_emoji_prefix(random.choice(options)))

    if streak == 3:
        options = [
            "–¢—Ä–∏ –¥–Ω—è –ø–æ–¥—Ä—è–¥ —Ç—ã –Ω–∞—Ö–æ–¥–∏—à—å —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ. –≠—Ç–æ –æ—á–µ–Ω—å —Ü–µ–Ω–Ω–æ.",
            "–¢—Ä–∏ –¥–Ω—è –ø–æ–¥—Ä—è–¥ —Å —Ä–∞–¥–æ—Å—Ç—è–º–∏. –ö–ª–∞—Å—Å–Ω—ã–π —Å—Ç—Ä–∏–∫.",
            "–¢—ã —É–∂–µ —Ç—Ä–∏ –¥–Ω—è –ø–æ–¥—Ä—è–¥ —É–¥–µ–ª—è–µ—à—å –≤–Ω–∏–º–∞–Ω–∏–µ —Ö–æ—Ä–æ—à–µ–º—É.",
        ]
        messages.append(add_emoji_prefix(random.choice(options)))
    elif streak == 7:
        options = [
            "–ù–µ–¥–µ–ª—è –ø–æ–¥—Ä—è–¥ —Å –º–∞–ª–µ–Ω—å–∫–∏–º–∏ —Ä–∞–¥–æ—Å—Ç—è–º–∏. –ö—Ä–∞—Å–∏–≤–∞—è —Å–µ—Ä–∏—è.",
            "–°–µ–º—å –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ —Ç—ã —á—Ç–æ-—Ç–æ –æ—Ç–º–µ—á–∞–µ—à—å –¥–ª—è —Å–µ–±—è. –≠—Ç–æ –º–Ω–æ–≥–æ.",
            "–ù–µ–¥–µ–ª—è –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤ ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ.",
        ]
        messages.append(add_emoji_prefix(random.choice(options)))
    elif streak == 30:
        options = [
            "30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚Äî –æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.",
            "–ú–µ—Å—è—Ü —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ —Ä–∞–¥–æ—Å—Ç—è–º–∏. –≠—Ç–æ –¥–æ—Å—Ç–æ–π–Ω–æ —É–≤–∞–∂–µ–Ω–∏—è.",
            "–¢—ã —Ü–µ–ª—ã–π –º–µ—Å—è—Ü –Ω–∞—Ö–æ–¥–∏—à—å —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
        ]
        messages.append(add_emoji_prefix(random.choice(options)))

    for m in messages:
        send_message(chat_id, m)


# --------------------------
# –†–∏—Ç—É–∞–ª ¬´3 –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∞–¥–æ—Å—Ç–∏¬ª
# --------------------------

def maybe_offer_ritual(chat_id: int):
    sad_count = get_sad_count_last_days(chat_id, SAD_RITUAL_DAYS)
    if sad_count >= SAD_RITUAL_THRESHOLD:
        send_message(
            chat_id,
            add_emoji_prefix(
                "–í–∏–∂—É, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏ –¥–∞—é—Ç—Å—è –Ω–µ–ø—Ä–æ—Å—Ç–æ.\n\n"
                "–ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∏—Ç—É–∞–ª: —Å–µ–≥–æ–¥–Ω—è –ø–µ—Ä–µ–¥ —Å–Ω–æ–º –æ—Ç–º–µ—Ç–∏—Ç—å –¥–ª—è —Å–µ–±—è —Ç—Ä–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∞–¥–æ—Å—Ç–∏. "
                "–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —á—Ç–æ-—Ç–æ –±–æ–ª—å—à–æ–µ ‚Äî –µ–¥–∞, —É—é—Ç, —Å–ø–æ–∫–æ–π–Ω—ã–π –º–æ–º–µ–Ω—Ç. "
                "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –∏—Ö –º–Ω–µ."
            ),
        )


# --------------------------
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å (22:00)
# --------------------------

def send_daily_report_for_user(chat_id: int):
    today_local = datetime.now().date()
    joys = get_joys_for_date(chat_id, today_local)

    if not joys:
        send_message(
            chat_id,
            add_emoji_prefix(
                "–°–µ–≥–æ–¥–Ω—è —É –º–µ–Ω—è –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π.\n"
                "–ï—Å–ª–∏ –¥–µ–Ω—å –±—ã–ª —Ç—è–∂—ë–ª—ã–º ‚Äî —Ç–∞–∫ —Ç–æ–∂–µ –±—ã–≤–∞–µ—Ç. –ó–∞–≤—Ç—Ä–∞ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞."
            )
        )
        return

    lines = []
    for created_at, text in joys:
        try:
            dt = datetime.fromisoformat(created_at)
            time_str = dt.strftime("%H:%M")
        except Exception:
            time_str = created_at[11:16]
        emo = random.choice(JOY_EMOJIS)
        lines.append(f"{emo} {time_str} ‚Äî {text}")

    header = "–í–æ—Ç —á—Ç–æ —Ö–æ—Ä–æ—à–µ–≥–æ —Ç—ã –æ—Ç–º–µ—Ç–∏–ª–∞ —Å–µ–≥–æ–¥–Ω—è:"
    body = "\n".join(lines)
    send_message(chat_id, f"{header}\n\n{body}")


# --------------------------
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ /stats
# --------------------------

def send_stats(chat_id: int):
    total = get_joy_count(chat_id)
    last7 = get_joys_last_n_days(chat_id, 7)
    streak = get_current_streak(chat_id)
    first_date = get_first_joy_date(chat_id)

    em = random.choice(STATS_EMOJIS)

    if total == 0:
        send_message(
            chat_id,
            f"{em} –ü–æ–∫–∞ —É —Ç–µ–±—è –Ω–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π.\n"
            "–ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –æ–¥–Ω–æ–π –Ω–µ–±–æ–ª—å—à–æ–π, –∫–æ–≥–¥–∞ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å —Ä–µ—Å—É—Ä—Å."
        )
        return

    first_str = first_date.strftime("%d.%m.%Y") if first_date else "‚Äî"

    lines = [
        f"{em} –ù–µ–±–æ–ª—å—à–∞—è —Å–≤–æ–¥–∫–∞:",
        "",
        f"‚Ä¢ –í—Å–µ–≥–æ —Ä–∞–¥–æ—Å—Ç–µ–π: {total}",
        f"‚Ä¢ –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π: {last7}",
        f"‚Ä¢ –¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫ –ø–æ –¥–Ω—è–º: {streak}",
        f"‚Ä¢ –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å: {first_str}",
    ]

    emo_stats = get_emotion_stats_last_days(chat_id, 7)
    if emo_stats:
        parts = []
        mapping = {
            "joy": "—Ä–∞–¥–æ—Å—Ç–∏",
            "sad": "–≥—Ä—É—Å—Ç—å",
            "tired": "—É—Å—Ç–∞–ª–æ—Å—Ç—å",
            "anxiety": "—Ç—Ä–µ–≤–æ–≥—É",
            "severe_sad": "–æ—á–µ–Ω—å —Ç—è–∂—ë–ª—ã–µ —á—É–≤—Å—Ç–≤–∞",
        }
        for key, label in mapping.items():
            if key in emo_stats:
                parts.append(f"{label}")
        if parts:
            lines.append("")
            lines.append("‚Ä¢ –≠–º–æ—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π: " + ", ".join(parts) + ".")

    theme_stats = get_theme_stats_last_days(chat_id, 7)
    if theme_stats:
        sorted_themes = sorted(theme_stats.items(), key=lambda x: x[1], reverse=True)
        theme_labels = []
        for theme, _ in sorted_themes[:3]:
            if theme == "–µ–¥–∞":
                theme_labels.append("—á—Ç–æ-—Ç–æ –≤–∫—É—Å–Ω–æ–µ")
            elif theme == "–ª—é–¥–∏":
                theme_labels.append("–ª—é–¥–∏ –∏ –æ–±—â–µ–Ω–∏–µ")
            elif theme == "–ø—Ä–∏—Ä–æ–¥–∞":
                theme_labels.append("–ø—Ä–∏—Ä–æ–¥–∞ –∏ –ø—Ä–æ–≥—É–ª–∫–∏")
            elif theme == "–æ—Ç–¥—ã—Ö":
                theme_labels.append("–æ—Ç–¥—ã—Ö –∏ –≤—Ä–µ–º—è –¥–ª—è —Å–µ–±—è")
            elif theme == "—É—Å–ø–µ—Ö–∏":
                theme_labels.append("—Ç–≤–æ–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã")

        if theme_labels:
            if len(theme_labels) == 1:
                nice = theme_labels[0]
            elif len(theme_labels) == 2:
                nice = " –∏ ".join(theme_labels)
            else:
                nice = ", ".join(theme_labels[:-1]) + " –∏ " + theme_labels[-1]

            lines.append("")
            lines.append(
                "‚Ä¢ –í –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏ —Ç–µ–±—è –æ—Å–æ–±–µ–Ω–Ω–æ —Ä–∞–¥—É—é—Ç: " + nice + "."
            )

    lines.append("")
    lines.append("–¢—ã —É–∂–µ –ø—Ä–æ–¥–µ–ª–∞–ª–∞ –∑–∞–º–µ—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –¥–ª—è —Å–µ–±—è.")

    send_message(chat_id, "\n".join(lines))


# --------------------------
# –≠–∫—Å–ø–æ—Ä—Ç /export
# --------------------------

def send_export(chat_id: int, days: int = 30):
    joys = get_joys_for_last_days(chat_id, days)
    if not joys:
        send_message(
            chat_id,
            add_emoji_prefix(
                "–ó–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ —É –º–µ–Ω—è –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π.\n"
                "–ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –æ—Ç–º–µ—á–∞—Ç—å –∏—Ö —É–∂–µ —Å–µ–≥–æ–¥–Ω—è."
            )
        )
        return

    header = f"–¢–≤–æ–∏ —Ä–∞–¥–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {days} –¥–Ω–µ–π:"
    lines = [header, ""]
    for created_at, text in joys:
        try:
            dt = datetime.fromisoformat(created_at)
            date_str = dt.strftime("%d.%m %H:%M")
        except Exception:
            date_str = created_at[:16]
        emo = random.choice(JOY_EMOJIS)
        lines.append(f"{emo} {date_str} ‚Äî {text}")

    full_text = "\n".join(lines)

    max_len = 3500
    if len(full_text) <= max_len:
        send_message(chat_id, full_text)
    else:
        chunk = []
        current_len = 0
        for line in lines:
            if current_len + len(line) + 1 > max_len:
                send_message(chat_id, "\n".join(chunk))
                chunk = []
                current_len = 0
            chunk.append(line)
            current_len += len(line) + 1
        if chunk:
            send_message(chat_id, "\n".join(chunk))


# --------------------------
# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞ —Ç–µ–º (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 22:15)
# --------------------------

def build_weekly_summary_text(chat_id: int) -> Optional[str]:
    total_week = get_joys_last_n_days(chat_id, 7)
    if total_week == 0:
        return add_emoji_prefix(
            "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ —É –º–µ–Ω—è –ø–æ—á—Ç–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–∞–¥–æ—Å—Ç–µ–π.\n"
            "–≠—Ç–æ –Ω–µ —É–ø—Ä—ë–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –º—è–≥–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Å –æ–¥–Ω–æ–π –Ω–µ–±–æ–ª—å—à–æ–π."
        )

    theme_stats = get_theme_stats_last_days(chat_id, 7)
    top_keywords = get_top_keywords(chat_id, 7, limit=5)

    theme_phrases = []
    if "–µ–¥–∞" in theme_stats:
        theme_phrases.append("—á—Ç–æ-—Ç–æ –≤–∫—É—Å–Ω–æ–µ")
    if "–ª—é–¥–∏" in theme_stats:
        theme_phrases.append("–ª—é–¥–∏ –∏ –æ–±—â–µ–Ω–∏–µ")
    if "–ø—Ä–∏—Ä–æ–¥–∞" in theme_stats:
        theme_phrases.append("–ø—Ä–∏—Ä–æ–¥–∞ –∏ –ø—Ä–æ–≥—É–ª–∫–∏")
    if "–æ—Ç–¥—ã—Ö" in theme_stats:
        theme_phrases.append("–æ—Ç–¥—ã—Ö –∏ –≤—Ä–µ–º—è –¥–ª—è —Å–µ–±—è")
    if "—É—Å–ø–µ—Ö–∏" in theme_stats:
        theme_phrases.append("—Ç–≤–æ–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã")

    parts: List[str] = []
    if top_keywords:
        parts.extend(top_keywords)
    if theme_phrases:
        parts.extend(theme_phrases)

    seen = set()
    unique_parts = []
    for p in parts:
        if p not in seen:
            seen.add(p)
            unique_parts.append(p)

    if not unique_parts:
        return add_emoji_prefix(
            "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ —É —Ç–µ–±—è –±—ã–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—ë–ø–ª—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤. "
            "–¢—ã –º–æ–∂–µ—à—å –ø–µ—Ä–µ—á–∏—Ç–∞—Ç—å –∏—Ö –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å."
        )

    display = unique_parts[:3]
    if len(display) == 1:
        nice = display[0]
    elif len(display) == 2:
        nice = " –∏ ".join(display)
    else:
        nice = ", ".join(display[:-1]) + " –∏ " + display[-1]

    return add_emoji_prefix(
        "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ —Ç–µ–±—è –æ—Å–æ–±–µ–Ω–Ω–æ —Ä–∞–¥–æ–≤–∞–ª–∏: " + nice + "."
    )


# --------------------------
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# --------------------------

def process_incoming_message(update: dict):
    if "message" not in update:
        return

    msg = update["message"]
    chat = msg.get("chat") or {}
    chat_id = chat.get("id")
    if chat_id is None:
        return

    text = msg.get("text", "")
    if not text:
        return

    stripped = text.strip()
    had_profanity = contains_profanity(stripped)

    # /start
    if stripped.startswith("/start"):
        send_message(
            chat_id,
            "–ü—Ä–∏–≤–µ—Ç. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –∑–∞–º–µ—á–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ —Ä–∞–¥–æ—Å—Ç–∏.\n\n"
            "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å —Å—é–¥–∞ —á—Ç–æ-—Ç–æ –ø—Ä–∏—è—Ç–Ω–æ–µ –∏–∑ –¥–Ω—è: –≤—Å—Ç—Ä–µ—á—É, –≤–∫—É—Å–Ω—ã–π –∫–æ—Ñ–µ, —Å–ø–æ–∫–æ–π–Ω—ã–π –≤–µ—á–µ—Ä.\n"
            "–í 19:00 —è –Ω–∞–ø–æ–º–Ω—é, –µ—Å–ª–∏ —Ç—ã –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∞, –∞ –≤ 22:00 –ø—Ä–∏—à–ª—é –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—á—ë—Ç –∑–∞ –¥–µ–Ω—å.\n\n"
            "–ö–æ–º–∞–Ω–¥—ã:\n"
            "‚Ä¢ /stats ‚Äî –Ω–µ–±–æ–ª—å—à–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞–¥–æ—Å—Ç—è–º –∏ —ç–º–æ—Ü–∏—è–º.\n"
            "‚Ä¢ /export ‚Äî —Ç–≤–æ–∏ —Ä–∞–¥–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.\n"
            "‚Ä¢ /letter —Ç–µ–∫—Å—Ç ‚Äî –ø–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ (—è –ø—Ä–∏—à–ª—é –µ–≥–æ —Ç–µ–±–µ –ø–æ–∑–∂–µ)."
        )
        return

    # /stats
    if stripped.startswith("/stats"):
        send_stats(chat_id)
        return

    # /export
    if stripped.startswith("/export"):
        send_export(chat_id, 30)
        return

    # /letter ‚Äî –ø–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ
    if stripped.startswith("/letter"):
        body = stripped[len("/letter"):].strip()
        if not body:
            send_message(
                chat_id,
                "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ, –ø—Ä–∏—à–ª–∏ –µ–≥–æ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç–∞–∫:\n\n"
                "/letter –¢–µ–∫—Å—Ç —Ç–≤–æ–µ–≥–æ –ø–∏—Å—å–º–∞"
            )
            return

        add_letter(chat_id, body, days_ahead=30)
        send_message(
            chat_id,
            add_emoji_prefix(
                "–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ —Ç–≤–æ—ë –ø–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ. "
                "–ß–µ—Ä–µ–∑ –∫–∞–∫–æ–µ-—Ç–æ –≤—Ä–µ–º—è —è –Ω–∞–ø–æ–º–Ω—é —Ç–µ–±–µ –æ –Ω—ë–º."
            )
        )
        return

    cleaned = clean_text_pipeline(text)
    if not cleaned:
        send_message(
            chat_id,
            "–ú–Ω–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∏—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.\n"
            "–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —á—É—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ, —á—Ç–æ —Ç–µ–±—è —Å–µ–≥–æ–¥–Ω—è –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ."
        )
        if had_profanity:
            handle_profanity(chat_id)
        return

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –æ—Ç–≤–µ—á–∞–µ–º, –Ω–æ –ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞–¥–æ—Å—Ç—å
    if is_greeting_message(cleaned):
        send_message(chat_id, get_greeting_response())
        add_message_emotion(chat_id, "other", cleaned)
        if had_profanity:
            handle_profanity(chat_id)
        return

    emotion = analyze_emotion(cleaned)

    # –æ—á–µ–Ω—å —Ç—è–∂—ë–ª—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if emotion == "severe_sad":
        send_message(
            chat_id,
            add_emoji_prefix(
                "–°–ª—ã—à—É, —á—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ.\n\n"
                "–° —Ç–∞–∫–∏–º–∏ —á—É–≤—Å—Ç–≤–∞–º–∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –æ–¥–Ω–æ–π. "
                "–ü–æ—Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —Ç–µ–º, –∫–æ–º—É –¥–æ–≤–µ—Ä—è–µ—à—å: –±–ª–∏–∑–∫–∏–π —á–µ–ª–æ–≤–µ–∫, –¥—Ä—É–≥, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç.\n"
                "–¢—ã –≤–∞–∂–Ω–∞ –∏ –∏–º–µ–µ—à—å –ø—Ä–∞–≤–æ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
            )
        )
        add_sad_event(chat_id)
        add_message_emotion(chat_id, "severe_sad", cleaned)
        maybe_offer_ritual(chat_id)
        if had_profanity:
            handle_profanity(chat_id)
        return

    # —Ç—Ä–µ–≤–æ–≥–∞
    if emotion == "anxiety":
        send_message(chat_id, get_anxiety_response())
        add_sad_event(chat_id)
        add_message_emotion(chat_id, "anxiety", cleaned)
        maybe_offer_ritual(chat_id)
        if had_profanity:
            handle_profanity(chat_id)
        return

    # —É—Å—Ç–∞–ª–æ—Å—Ç—å
    if emotion == "tired":
        send_message(chat_id, get_tired_response())
        add_sad_event(chat_id)
        add_message_emotion(chat_id, "tired", cleaned)
        maybe_offer_ritual(chat_id)
        if had_profanity:
            handle_profanity(chat_id)
        return

    # –≥—Ä—É—Å—Ç—å
    if emotion == "sad":
        send_message(chat_id, get_sad_response())
        add_sad_event(chat_id)
        add_message_emotion(chat_id, "sad", cleaned)
        maybe_offer_ritual(chat_id)
        if had_profanity:
            handle_profanity(chat_id)
        return

    # –æ–±—ã—á–Ω–∞—è —Ä–∞–¥–æ—Å—Ç—å
    add_joy(chat_id, cleaned)
    add_message_emotion(chat_id, "joy", cleaned)
    keywords = extract_keywords(cleaned)
    add_joy_keywords(chat_id, keywords)

    send_message(chat_id, get_joy_response())

    # –∞–Ω–∞–ª–∏–∑ —Ç–µ–º
    themes = detect_joy_themes(cleaned)
    if themes:
        main_theme = themes[0]
        comments = JOY_THEME_COMMENTS.get(main_theme)
        if comments and random.random() < 0.5:
            send_message(chat_id, add_emoji_prefix(random.choice(comments)))

    check_and_send_achievements(chat_id)

    if had_profanity:
        handle_profanity(chat_id)


# --------------------------
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ 19:00
# --------------------------

def daily_reminder_runner():
    print("Daily reminder runner started.")
    reminded_dates = set()

    while True:
        now = datetime.now()
        today = now.date()

        for d in list(reminded_dates):
            if d != today:
                reminded_dates.remove(d)

        if now.hour == 19 and now.minute == 0:
            if today not in reminded_dates:
                print("Sending daily reminders...")
                for user_id in get_all_user_ids():
                    try:
                        if not has_joy_for_date(user_id, today):
                            emo = random.choice(REMINDER_EMOJIS)
                            text = random.choice(REMINDER_TEXTS)
                            send_message(
                                user_id,
                                f"{emo} {text}"
                            )
                    except Exception as e:
                        print(f"Error sending daily reminder to {user_id}:", e)
                reminded_dates.add(today)

        time.sleep(60)


# --------------------------
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –≤ 22:00
# --------------------------

def daily_report_runner():
    print("Daily report runner started.")
    reported_dates = set()

    while True:
        now = datetime.now()
        today = now.date()

        for d in list(reported_dates):
            if d != today:
                reported_dates.remove(d)

        if now.hour == 22 and now.minute == 0:
            if today not in reported_dates:
                print("Sending daily reports...")
                for user_id in get_all_user_ids():
                    try:
                        send_daily_report_for_user(user_id)
                    except Exception as e:
                        print(f"Error sending daily report to {user_id}:", e)
                reported_dates.add(today)

        time.sleep(60)


# --------------------------
# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Ç–µ–º –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 22:15
# --------------------------

def weekly_themes_report_runner():
    print("Weekly themes report runner started.")
    sent_weeks = set()  # (year, week_number)

    while True:
        now = datetime.now()
        today = now.date()
        year, week_num, _ = today.isocalendar()

        for key in list(sent_weeks):
            if key[0] < year or (key[0] == year and key[1] < week_num):
                sent_weeks.remove(key)

        if now.isoweekday() == 7 and now.hour == 22 and now.minute == 15:
            key = (year, week_num)
            if key not in sent_weeks:
                print("Sending weekly themes summaries...")
                for user_id in get_all_user_ids():
                    try:
                        text = build_weekly_summary_text(user_id)
                        if text:
                            send_message(user_id, text)
                    except Exception as e:
                        print(f"Error sending weekly summary to {user_id}:", e)
                sent_weeks.add(key)

        time.sleep(60)


# --------------------------
# –ü–∏—Å—å–º–∞ –≤ –±—É–¥—É—â–µ–µ (runner)
# --------------------------

def letters_runner():
    print("Letters runner started.")
    while True:
        try:
            due = get_due_letters()
            for letter_id, chat_id, text in due:
                msg = (
                    "üìù –í–æ—Ç –ø–∏—Å—å–º–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª–∞ —Å–µ–±–µ –∫–∞–∫–æ–µ-—Ç–æ –≤—Ä–µ–º—è –Ω–∞–∑–∞–¥:\n\n"
                    f"{text}"
                )
                send_message(chat_id, msg)
                mark_letter_sent(letter_id)
        except Exception as e:
            print("letters_runner error:", e)
        time.sleep(60)


# --------------------------
# –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –±–æ—Ç–∞
# --------------------------

def main():
    init_db()

    t_daily_reminder = threading.Thread(target=daily_reminder_runner, daemon=True)
    t_daily_reminder.start()

    t_daily_report = threading.Thread(target=daily_report_runner, daemon=True)
    t_daily_report.start()

    t_weekly_summary = threading.Thread(target=weekly_themes_report_runner, daemon=True)
    t_weekly_summary.start()

    t_letters = threading.Thread(target=letters_runner, daemon=True)
    t_letters.start()

    offset = None
    print("ChudoMoodo bot polling started...")
    while True:
        updates = get_updates(offset=offset, timeout=POLL_TIMEOUT)
        for upd in updates:
            try:
                offset = max(offset or 0, upd["update_id"] + 1)
                process_incoming_message(upd)
            except Exception as e:
                print("process error:", e)
        time.sleep(POLL_SLEEP)


if __name__ == "__main__":
    main()
