"""
chudomoodo_bot.py

Telegram-бот "Дневник маленьких радостей".

Функционал:
- принимает от пользователя короткие тексты-радости;
- очищает мат и нецензурную лексику (полностью удаляет такие слова);
- (опционально) исправляет орфографию и пунктуацию через LanguageTool;
- сохраняет радости в SQLite;
- ЕЖЕДНЕВНЫЙ РЕЖИМ:
    - в 18:00 — напоминание, если за день не было ни одной радости;
    - в 21:00 — отчёт с радостями за текущий день;
- защита от тоски: отдельные реакции на грусть, усталость, тревогу, тяжёлые фразы;
- спокойные тексты-ответы с одним эмодзи в начале;
- ачивки за количество радостей и стрики по дням (без упора на цифры в формулировках);
- статистика по команде /stats;
- ритуал «3 маленькие радости» (сейчас без дополнительных сообщений, чтобы не было спама);
- микродиалоги: бот может попросить найти одну маленькую опору;
- персонализация по темам радостей (еда, люди, природа, отдых, успехи);
- недельные и месячные обзоры по-человечески;
- письма себе в будущее по команде /letter (через 7 / 14 / 30 дней);
- возможность отменить письмо или микродиалог командой /cancel или словами "отмена", "я передумала" и т.п.
"""

import os
import time
import sqlite3
import threading
import random
import re
import json
from datetime import datetime, timedelta, date
from typing import List, Tuple, Optional, Dict

import requests

# --------------------------
# CONFIG
# --------------------------

TOKEN = os.getenv("TELEGRAM_TOKEN")
if not TOKEN:
    raise RuntimeError("Не задан TELEGRAM_TOKEN в переменных окружения.")

API_URL = f"https://api.telegram.org/bot{TOKEN}"
DB_PATH = os.path.join(os.path.dirname(__file__), "joys.db")

POLL_TIMEOUT = 30
POLL_SLEEP = 1

USE_LANGTOOL = False
LANGTOOL_URL = "https://api.languagetool.org/v2/check"

# --------------------------
# Лексика
# --------------------------

# Расширенный список нецензурной лексики
# ВАЖНО: каждое слово в кавычках и с запятой, без обрывов строк.
BAD_WORDS = [
    "хуй", "хуя", "хую", "хуем", "хуи",
    "хер", "хера", "херу", "хером", "херня",
    "пизда", "пизды", "пиздец", "пиздеца", "пиздецу", "пиздецом",
    "пиздёж", "пиздеж", "пиздеть", "пиздишь", "пиздит", "пиздел", "пиздела",
    "пиздануть", "пизданул", "пизданула", "пиздануло",
    "пиздатый", "пиздатая", "пиздатые", "пиздато",
    "блядь", "блять", "бля", "бляха", "бляха-муха",
    "блядская", "блядский", "блядские", "бляди", "блядина",
    "ебать", "ебу", "ебёшь", "ебешь", "ебёт", "ебет", "ебали", "ебал", "ебала",
    "ебаный", "ебаная", "ебаное", "ебаные",
    "ёбаный", "ёбаная", "ёбаное", "ёбаные",
    "ебанутая", "ебанутый", "ебанутые",
    "ёбанутая", "ёбанутый", "ёбанутые",
    "ебануло", "ебнуло", "ебанулся", "ебанулось",
    "выебать", "выебал", "выебала", "выебали",
    "проебать", "проебал", "проебала", "проебали", "проёб", "проеб",
    "сука", "суки", "сукин", "сукина", "сукины",
    "сучка", "сучки", "сучара", "сучары",
    "манда", "мандавошка", "мандавошки",
    "жопа", "жопы", "жопка", "жопки", "жопища",
    "вжопу", "в жопу",
    "говно", "говна", "говном", "говняный", "говнистый",
    "дерьмо", "дерьма", "дерьмовый",
    "мудак", "мудаки", "мудачок", "мудачье", "мудацкий",
    "козёл", "козел", "козлина", "козлище",
    "идиот", "идиоты", "идиотка", "идиотский",
    "дебил", "дебилы", "дебильный",
    "долбоёб", "долбоеб", "долбоёбы", "долбоебы",
    "еблан", "ёблан", "ебланы", "ёбланы",
    "пидор", "пидоры", "пидорас", "пидорасы",
    "пидрила", "пидрилы",
    "гондон", "гандон", "гандоны",
    "мразь", "мрази", "мразота",
    "ублюдок", "ублюдки",
    "нахуй", "нахер", "нахрен", "нах",
    "иди нахуй", "пошёл нахуй", "пошел нахуй", "пошла нахуй",
    "срать", "насрать", "обосрался", "обосралась",
    "залупа", "залупы",
    "херовый", "херово",
    "трахаться", "трахнул", "трахнула", "трахнули",
]

# Расширенные шаблоны для грусти, усталости, тревоги и "не знаю, что написать"

ANXIETY_PATTERNS = [
    "боюсь",
    "мне страшно",
    "страшно",
    "переживаю",
    "я переживаю",
    "тревожно",
    "очень тревожно",
    "безумно тревожно",
    "паника",
    "паническую",
    "паническая атака",
    "панические атаки",
    "паникую",
    "меня трясет",
    "меня трясёт",
    "я вся на нервах",
    "я весь на нервах",
    "нервничаю",
    "очень нервничаю",
    "ужасно нервничаю",
    "сердце колотится",
    "сердце сильно бьется",
    "сердце сильно бьётся",
    "ком в горле",
    "дрожат руки",
    "руки дрожат",
    "не могу успокоиться",
    "не получается успокоиться",
    "боюсь, что будет плохо",
    "боюсь что будет плохо",
    "боюсь будущего",
    "страх будущего",
    "страх ошибки",
    "я боюсь ошибиться",
    "боюсь ошибиться",
    "я не уверена",
    "я не уверен",
    "не уверена в себе",
    "не уверен в себе",
    "я всё испортила",
    "я все испортила",
    "я всё испортил",
    "я все испортил",
    "очень волнуюсь",
    "сильно волнуюсь",
    "я волнуюсь",
]


TIRED_PATTERNS = [
    "устала",
    "устал",
    "я так устала",
    "я так устал",
    "очень устала",
    "очень устал",
    "сильно устала",
    "сильно устал",
    "сил нет",
    "нет сил",
    "ни на что нет сил",
    "совсем нет сил",
    "абсолютно нет сил",
    "выгорела",
    "выгорел",
    "я выгорела",
    "я выгорел",
    "эмоционально выгорела",
    "эмоционально выгорел",
    "морально выгорела",
    "морально выгорел",
    "мне тяжело",
    "очень тяжело",
    "безумно устала",
    "безумно устал",
    "устала морально",
    "устал морально",
    "устала физически",
    "устал физически",
    "хочу спать",
    "очень хочу спать",
    "засыпаю на ходу",
    "еле держусь",
    "еле стою на ногах",
    "еле тяну день",
    "переутомилась",
    "переутомился",
    "выжата как лимон",
    "выжат как лимон",
    "батарейка на нуле",
    "совсем вымоталась",
    "совсем вымотался",
    "вымотана",
    "вымотан",
]

ANXIETY_PATTERNS = [
    "боюсь",
    "мне страшно",
    "страшно",
    "переживаю",
    "я переживаю",
    "тревожно",
    "очень тревожно",
    "безумно тревожно",
    "меня трясет",
    "па

